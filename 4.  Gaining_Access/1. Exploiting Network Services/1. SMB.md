# SMB 



## What is SMB & where it run?
- SMB (Server Message Block) â€” file & printer sharing protocol used by Windows and Samba (Linux).
- Common ports:
  - TCP 445 (direct SMB over TCP) â€” main one today.
  - TCP 139 (NetBIOS-SSN) â€” legacy/NetBIOS-era SMB.
  - UDP 137-138 (NetBIOS name/service/browsing) â€” older environments.
- SMB versions: SMBv1, SMBv2, SMBv3 â€” SMBv1 is insecure and often targeted.


## Scope 
- **Attacker**: Kali Linux (IP: 192.168.127.128)
- **Target**: Metasploitable v2 (192.168.127.129)



# SMB Penetration Testing Methodology

##  Infromation Gathering
### Network Scanning
#### Scan Range
````
nmap -sn -T4 192.168.127.0/24 
````
<img width="805" height="446" alt="image" src="https://github.com/user-attachments/assets/70977d79-d790-494f-8262-82e841c172c9" />

#### Scan details port target
````
nmap -sCV -T4 192.168.127.129
````
<img width="729" height="784" alt="image" src="https://github.com/user-attachments/assets/2b345a18-9406-4917-99bb-a524eec9a3b0" />

<img width="766" height="557" alt="image" src="https://github.com/user-attachments/assets/64d22326-51e5-47d3-8c85-4ce192c91f2a" />

#### Nmap SMB Scan
````
nmap -p 139,445 --open 192.168.127.129
````
<img width="799" height="308" alt="image" src="https://github.com/user-attachments/assets/06e5acd5-dea7-458a-80c7-d4d06f6da192" />


#### SMB service detection
````
nmap -p 139,445 -sV --script smb-os-discovery 192.168.127.0/24
````
<img width="1146" height="549" alt="image" src="https://github.com/user-attachments/assets/85954f1c-7ae2-4f64-8947-b5dc055bb0c3" />


#### Aggressive SMB scanning
````
nmap -p 139,445 -A --script smb* 192.168.127.129
````
<img width="1021" height="767" alt="image" src="https://github.com/user-attachments/assets/2933f023-2db5-4486-bb40-e7387b8e8790" />

<img width="702" height="808" alt="image" src="https://github.com/user-attachments/assets/823588fd-2741-4e44-867a-d1cf9b416f8d" />

<img width="1017" height="770" alt="image" src="https://github.com/user-attachments/assets/6a021688-a28d-4ac1-a733-0de87e869603" />


### SMB Service Enumeration
#### SMB version detection
````
nmap -p 445 --script smb-protocols 192.168.127.129
````
<img width="667" height="362" alt="image" src="https://github.com/user-attachments/assets/2b1ceee3-1a9f-43e3-8e55-baf092f2bd9c" />

#### OS and share information
````
nmap -p 445 --script smb-os-discovery,smb-enum-shares 192.168.127.129
````
<img width="738" height="775" alt="image" src="https://github.com/user-attachments/assets/2ade5ac3-8f1a-4687-a8e6-7579db418204" />

<img width="624" height="522" alt="image" src="https://github.com/user-attachments/assets/e906a738-e344-4a37-ac6f-b43a9e9f6f7f" />


## Enumeration

### Share Enumeration
#### Using smbclient for share listingðŸ˜£
````
smbclient -L //192.168.127.129 -N
````
<img width="943" height="437" alt="image" src="https://github.com/user-attachments/assets/2867b209-1288-4e3d-bd22-e9b7faa13f0c" />


#### Using rpcclient for share enumeration
````
rpcclient -U "" -N 192.168.127.129
  srvinfo
  enumdomusers
  netshareenum
````
<img width="891" height="806" alt="image" src="https://github.com/user-attachments/assets/6f36229b-f64c-48ab-868b-6f614413ecca" />

<img width="324" height="455" alt="image" src="https://github.com/user-attachments/assets/1067a4aa-8117-4cc0-ab22-e7d2f877daf9" />


#### Using enum4linux for comprehensive enumeration
````
enum4linux -a 192.168.127.129
````
<img width="1126" height="772" alt="image" src="https://github.com/user-attachments/assets/85f4e2ae-a77c-4bb9-8321-60db0bdf1191" />

<img width="1188" height="794" alt="image" src="https://github.com/user-attachments/assets/b14d6f58-22cb-40cd-8997-2ee7344a1d5b" />

<img width="1039" height="728" alt="image" src="https://github.com/user-attachments/assets/4d6be3c4-cc28-456f-838d-5ae2bab3c059" />

<img width="1077" height="797" alt="image" src="https://github.com/user-attachments/assets/7200a828-2f50-49e9-bed7-29151c8b7167" />


#### Using CrackMapExec for share enumeration
````
crackmapexec smb 192.168.127.129 --shares
````
<img width="1353" height="98" alt="image" src="https://github.com/user-attachments/assets/976f73ea-7829-4ca7-acc0-b9243bf5a15e" />


### User Enumeration
#### Enumerate users via RPC
````
nmap -p 445 --script smb-enum-users 192.168.127.129
````
<img width="653" height="720" alt="image" src="https://github.com/user-attachments/assets/08369f02-1bc5-47ea-84cf-ab886c075944" />


#### Using rpcclient for user enumeration
````
rpcclient -U "" -N 192.168.127.129
  enumdomusers
  queryuser msfadmin
````
<img width="471" height="737" alt="image" src="https://github.com/user-attachments/assets/34092c9a-a05e-41bc-a9fa-dc421bbe2742" />

<img width="736" height="549" alt="image" src="https://github.com/user-attachments/assets/6e1498ad-3549-47db-bddf-7d99385c3f27" />

#### Using enum4linux for user enumeration
````
enum4linux -U 192.168.127.129
````
<img width="976" height="682" alt="image" src="https://github.com/user-attachments/assets/3887b041-6f31-4b26-bab9-8d822d267aee" />


### Password Policy Discovery

#### Check password policy
````
nmap -p 445 --script smb-security-mode 192.168.127.129
````
<img width="654" height="371" alt="image" src="https://github.com/user-attachments/assets/2403d96c-2a38-4ddf-8318-710ad02370ff" />


#### Using rpcclient
````
rpcclient -U "" -N 192.168.127.129
  getdompwinfo
````
<img width="358" height="129" alt="image" src="https://github.com/user-attachments/assets/7bb4ce0e-e926-49c8-ba46-770d9b9a6d5f" />


#### Using enum4linux
````
enum4linux -P 192.168.127.129
````
<img width="1025" height="702" alt="image" src="https://github.com/user-attachments/assets/2befc54b-05e0-40d3-9823-ee500d6f4760" />

<img width="547" height="741" alt="image" src="https://github.com/user-attachments/assets/d6b178dd-22b4-4f8c-a555-9434123ade19" />


##  Vulnerability Assessment

### SMB Vulnerability Scanning
#### Scan for common SMB vulnerabilities
````
nmap -p 445 --script smb-vuln* 192.168.127.129
````
<img width="740" height="336" alt="image" src="https://github.com/user-attachments/assets/2ba85a49-327d-4601-ae67-c815cfb7a663" />


#### Check for EternalBlue (MS17-010)
````
nmap -p 445 --script smb-vuln-ms17-010 192.168.127.129
````
<img width="650" height="236" alt="image" src="https://github.com/user-attachments/assets/91067303-e6f9-4291-bf18-6a68bd28267b" />


#### Check for SMB signing
````
nmap -p 445 --script smb2-security-mode 192.168.127.129
````
<img width="658" height="231" alt="image" src="https://github.com/user-attachments/assets/088b16be-9952-4c67-895e-e83be0feaa42" />



#### Comprehensive vulnerability scan
````
nmap -p 445 --script "smb-vuln-* and safe" 192.168.127.129
````
<img width="643" height="235" alt="image" src="https://github.com/user-attachments/assets/530dda58-f6d5-4a23-8132-9e8de7c5d0fc" />



### Manual Vulnerability Testing
#### Test for anonymous access
````
smbclient //192.168.127.129/IPC$ -N
````
<img width="754" height="499" alt="image" src="https://github.com/user-attachments/assets/4a857465-3d4c-4b4b-8346-514316e55ad3" />




## Authentication Testing

### Password Spraying
#### Using CrackMapExec for password spraying
````
crackmapexec smb 192.168.127.129 -u msfadmin -p /usr/share/wordlists/wordlist.txt --continue-on-success
````
<img width="1342" height="752" alt="image" src="https://github.com/user-attachments/assets/c8da962d-5895-4feb-a1d9-6e4b7b17c6d9" />

<img width="1119" height="511" alt="image" src="https://github.com/user-attachments/assets/bc08ce09-6203-4610-a0b9-17045c08c55e" />

- In this we found `password`


### Brute Force Attacks
#### Using hydra for SMB brute force
````
hydra -l msfadmin -P /usr/share/wordlists/wordlist.txt 192.168.127.129 smb
````
<img width="1056" height="699" alt="image" src="https://github.com/user-attachments/assets/cf186011-8871-43a9-b675-413e2f4a0821" />

<img width="931" height="281" alt="image" src="https://github.com/user-attachments/assets/16409ea5-328d-4c65-903b-2bb9a00c89c9" />

- Now we see the correct password.


#### Using medusa
````
medusa -h 192.168.127.129 -U /usr/share/wordlists/user.txt -P /usr/share/wordlists/wordlist.txt -M smbnt
````
<img width="1056" height="602" alt="image" src="https://github.com/user-attachments/assets/afa036f2-3f57-42bf-a437-4b2011ff7163" />

<img width="1455" height="467" alt="image" src="https://github.com/user-attachments/assets/cc431be7-7c64-4416-b2cd-3abaef00942e" />

- In this we found the correct `password`

#### Using Nmap script
````
nmap -p 445 --script smb-brute 192.168.127.129
````
<img width="610" height="326" alt="image" src="https://github.com/user-attachments/assets/b15101d1-719a-4559-b1f9-1f88d2cdbe25" />


----


## Exploitation





























